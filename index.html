<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor Pro</title>
    
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" id="hljs-theme">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <!-- CodeMirror 5 for editor syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/default.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/gfm/gfm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/mode/overlay.min.js"></script>
    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- html2canvas for PNG export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Theme */
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f0f0;
            --text-primary: #1a1a2e;
            --text-secondary: #4a4a5a;
            --text-muted: #8a8a9a;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.08);
            --divider: #d0d0d0;
            --success: #10b981;
            --warning: #f59e0b;
            --toolbar-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --editor-bg: #ffffff;
            --preview-bg: #fefefe;
            --code-bg: #f6f8fa;
            --scrollbar-track: #f0f0f0;
            --scrollbar-thumb: #c0c0c0;
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252540;
            --text-primary: #e8e8f0;
            --text-secondary: #b0b0c0;
            --text-muted: #6a6a7a;
            --accent: #818cf8;
            --accent-hover: #a5b4fc;
            --accent-light: rgba(129, 140, 248, 0.15);
            --border: #2a2a40;
            --shadow: rgba(0, 0, 0, 0.3);
            --divider: #3a3a50;
            --toolbar-bg: linear-gradient(135deg, #1e1e3f 0%, #2d1b4e 100%);
            --editor-bg: #12121f;
            --preview-bg: #16162a;
            --code-bg: #1e1e2e;
            --scrollbar-track: #1a1a2e;
            --scrollbar-thumb: #3a3a50;
        }

        /* Color Themes */
        [data-color="indigo"] {
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --toolbar-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        [data-theme="dark"][data-color="indigo"] {
            --accent: #818cf8;
            --accent-hover: #a5b4fc;
            --accent-light: rgba(129, 140, 248, 0.15);
            --toolbar-bg: linear-gradient(135deg, #1e1e3f 0%, #2d1b4e 100%);
        }

        [data-color="blue"] {
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-light: rgba(59, 130, 246, 0.1);
            --toolbar-bg: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        [data-theme="dark"][data-color="blue"] {
            --accent: #60a5fa;
            --accent-hover: #93c5fd;
            --accent-light: rgba(96, 165, 250, 0.15);
            --toolbar-bg: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
        }

        [data-color="emerald"] {
            --accent: #10b981;
            --accent-hover: #059669;
            --accent-light: rgba(16, 185, 129, 0.1);
            --toolbar-bg: linear-gradient(135deg, #10b981 0%, #047857 100%);
        }
        [data-theme="dark"][data-color="emerald"] {
            --accent: #34d399;
            --accent-hover: #6ee7b7;
            --accent-light: rgba(52, 211, 153, 0.15);
            --toolbar-bg: linear-gradient(135deg, #064e3b 0%, #047857 100%);
        }

        [data-color="rose"] {
            --accent: #f43f5e;
            --accent-hover: #e11d48;
            --accent-light: rgba(244, 63, 94, 0.1);
            --toolbar-bg: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
        }
        [data-theme="dark"][data-color="rose"] {
            --accent: #fb7185;
            --accent-hover: #fda4af;
            --accent-light: rgba(251, 113, 133, 0.15);
            --toolbar-bg: linear-gradient(135deg, #4c0519 0%, #9f1239 100%);
        }

        [data-color="amber"] {
            --accent: #f59e0b;
            --accent-hover: #d97706;
            --accent-light: rgba(245, 158, 11, 0.1);
            --toolbar-bg: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
        }
        [data-theme="dark"][data-color="amber"] {
            --accent: #fbbf24;
            --accent-hover: #fcd34d;
            --accent-light: rgba(251, 191, 36, 0.15);
            --toolbar-bg: linear-gradient(135deg, #451a03 0%, #92400e 100%);
        }

        [data-color="cyan"] {
            --accent: #06b6d4;
            --accent-hover: #0891b2;
            --accent-light: rgba(6, 182, 212, 0.1);
            --toolbar-bg: linear-gradient(135deg, #06b6d4 0%, #0e7490 100%);
        }
        [data-theme="dark"][data-color="cyan"] {
            --accent: #22d3ee;
            --accent-hover: #67e8f9;
            --accent-light: rgba(34, 211, 238, 0.15);
            --toolbar-bg: linear-gradient(135deg, #083344 0%, #0e7490 100%);
        }

        [data-color="violet"] {
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --accent-light: rgba(139, 92, 246, 0.1);
            --toolbar-bg: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        }
        [data-theme="dark"][data-color="violet"] {
            --accent: #a78bfa;
            --accent-hover: #c4b5fd;
            --accent-light: rgba(167, 139, 250, 0.15);
            --toolbar-bg: linear-gradient(135deg, #2e1065 0%, #5b21b6 100%);
        }

        [data-color="slate"] {
            --accent: #64748b;
            --accent-hover: #475569;
            --accent-light: rgba(100, 116, 139, 0.1);
            --toolbar-bg: linear-gradient(135deg, #64748b 0%, #334155 100%);
        }
        [data-theme="dark"][data-color="slate"] {
            --accent: #94a3b8;
            --accent-hover: #cbd5e1;
            --accent-light: rgba(148, 163, 184, 0.15);
            --toolbar-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 5px;
            transition: background 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Toolbar */
        .toolbar {
            background: var(--toolbar-bg);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            z-index: 100;
        }

        .toolbar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-title svg {
            width: 28px;
            height: 28px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toolbar-group:first-of-type {
            border-left: none;
            padding-left: 0;
        }

        .toolbar-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0);
        }

        .toolbar-btn svg {
            width: 16px;
            height: 16px;
        }

        .file-name {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'JetBrains Mono', monospace;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .spacer {
            flex: 1;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(15deg);
        }

        .theme-toggle svg {
            width: 22px;
            height: 22px;
            color: white;
        }

        /* Main Container */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Editor Panel */
        .editor-panel {
            width: 50%;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            background: var(--editor-bg);
            border-right: 1px solid var(--border);
        }

        .panel-header {
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--accent);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-header svg {
            width: 16px;
            height: 16px;
            color: var(--accent);
            opacity: 1;
        }

        #editor-wrapper {
            flex: 1;
            overflow: hidden;
            background: var(--editor-bg);
        }

        #editor-wrapper .CodeMirror {
            height: 100%;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.7;
            background: var(--editor-bg);
            color: var(--text-primary);
        }

        #editor-wrapper .CodeMirror-gutters {
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border);
        }

        #editor-wrapper .CodeMirror-linenumber {
            color: var(--text-muted);
            padding: 0 8px;
        }

        #editor-wrapper .CodeMirror-cursor {
            border-left-color: var(--accent);
        }

        #editor-wrapper .CodeMirror-selected {
            background: var(--accent-light) !important;
        }

        #editor-wrapper .CodeMirror-focused .CodeMirror-selected {
            background: var(--accent-light) !important;
        }

        /* CodeMirror Markdown syntax colors */
        .cm-header { color: var(--accent); font-weight: bold; }
        .cm-header-1 { font-size: 1.4em; }
        .cm-header-2 { font-size: 1.2em; }
        .cm-header-3 { font-size: 1.1em; }
        .cm-strong { font-weight: bold; color: var(--text-primary); }
        .cm-em { font-style: italic; color: var(--text-secondary); }
        .cm-link { color: #58a6ff; }
        .cm-url { color: var(--text-muted); }
        .cm-comment { color: var(--text-muted); }
        .cm-quote { color: var(--text-secondary); font-style: italic; }
        .cm-code, .cm-inline-code {
            background: var(--code-bg);
            color: #e06c75;
            border-radius: 3px;
            padding: 1px 4px;
        }
        .cm-keyword { color: #c678dd; }
        .cm-def { color: #61afef; }
        .cm-variable { color: var(--text-primary); }
        .cm-variable-2 { color: #e5c07b; }
        .cm-string { color: #98c379; }
        .cm-number { color: #d19a66; }
        .cm-atom { color: #d19a66; }
        .cm-property { color: #61afef; }
        .cm-operator { color: #56b6c2; }

        /* Math highlighting */
        .cm-math-inline {
            color: #c678dd;
            background: rgba(198, 120, 221, 0.12);
            border-radius: 3px;
            padding: 0 2px;
        }
        .cm-math-delimiter {
            color: #c678dd;
            font-weight: bold;
        }
        .cm-math-block {
            color: #c678dd;
            background: rgba(198, 120, 221, 0.08);
        }
        [data-theme="dark"] .cm-math-inline {
            color: #d19a66;
            background: rgba(209, 154, 102, 0.18);
        }
        [data-theme="dark"] .cm-math-delimiter {
            color: #d19a66;
        }
        [data-theme="dark"] .cm-math-block {
            color: #d19a66;
            background: rgba(209, 154, 102, 0.12);
        }

        /* Mermaid code block highlighting - green color */
        .cm-mermaid-code {
            color: #50a14f;
        }
        [data-theme="dark"] .cm-mermaid-code {
            color: #98c379;
        }

        /* Dark mode specific overrides for CodeMirror */
        [data-theme="dark"] .cm-code,
        [data-theme="dark"] .cm-inline-code {
            background: var(--code-bg);
            color: #e06c75;
        }

        /* Dark mode: Better visibility for code block content */
        [data-theme="dark"] .cm-s-material-darker .cm-comment {
            color: #a0a8b7;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-string {
            color: #98c379;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-keyword {
            color: #c678dd;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-variable,
        [data-theme="dark"] .cm-s-material-darker .cm-variable-2 {
            color: #e5c07b;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-def {
            color: #61afef;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-property {
            color: #61afef;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-atom {
            color: #d19a66;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-number {
            color: #d19a66;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-operator {
            color: #56b6c2;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-meta {
            color: #c8ccd4;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-tag {
            color: #e06c75;
        }
        [data-theme="dark"] .cm-s-material-darker .cm-attribute {
            color: #d19a66;
        }

        /* Dark mode: Mermaid/code block text - brighter for readability */
        [data-theme="dark"] .CodeMirror-code .cm-comment {
            color: #b8bfc9 !important;
        }
        [data-theme="dark"] .CodeMirror pre.CodeMirror-line {
            color: #d0d4dc;
        }

        #editor {
            flex: 1;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.7;
            background: var(--editor-bg);
            color: var(--text-primary);
            border: none;
            outline: none;
            resize: none;
            tab-size: 4;
            caret-color: var(--accent);
            display: none; /* Hidden when CodeMirror is active */
        }

        #editor::placeholder {
            color: var(--text-muted);
        }

        #editor::selection {
            background: var(--accent-light);
            color: var(--text-primary);
        }

        /* Resizer */
        .resizer {
            width: 6px;
            background: var(--divider);
            cursor: col-resize;
            transition: background 0.2s ease;
            position: relative;
        }

        .resizer:hover,
        .resizer.active {
            background: var(--accent);
        }

        .resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 40px;
            background: var(--text-muted);
            border-radius: 1px;
            opacity: 0.5;
        }

        /* Preview Panel */
        .preview-panel {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            background: var(--preview-bg);
            overflow: hidden;
        }

        #preview {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
            line-height: 1.8;
        }

        /* Markdown Styles */
        #preview h1 {
            font-size: 2em;
            font-weight: 700;
            margin: 1.5em 0 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 3px solid var(--accent);
            color: var(--text-primary);
        }

        #preview h1:first-child {
            margin-top: 0;
        }

        #preview h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 1.3em 0 0.4em;
            color: var(--text-primary);
            padding-left: 12px;
            border-left: 4px solid var(--accent);
        }

        #preview h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 1.2em 0 0.4em;
            color: var(--accent);
        }

        #preview h4, #preview h5, #preview h6 {
            font-size: 1em;
            font-weight: 600;
            margin: 1em 0 0.4em;
            color: var(--text-secondary);
        }

        #preview p {
            margin: 0.8em 0;
            color: var(--text-primary);
        }

        #preview strong {
            color: var(--accent);
            font-weight: 600;
        }

        #preview a {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px solid var(--accent-light);
            transition: border-color 0.2s ease;
        }

        #preview a:hover {
            border-bottom-color: var(--accent);
        }

        #preview ul, #preview ol {
            margin: 0.8em 0;
            padding-left: 2em;
        }

        #preview li {
            margin: 0.3em 0;
        }

        #preview li::marker {
            color: var(--accent);
        }

        #preview blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            border-left: 4px solid var(--accent);
            background: var(--accent-light);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
        }

        #preview code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            background: var(--accent-light);
            padding: 0.2em 0.5em;
            border-radius: 4px;
            color: var(--accent);
        }

        #preview pre {
            margin: 1em 0;
            padding: 16px;
            background: var(--code-bg);
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
        }

        #preview pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }

        #preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        #preview th, #preview td {
            padding: 10px 14px;
            border: 1px solid var(--border);
            text-align: left;
        }

        #preview th {
            background: var(--accent-light);
            font-weight: 600;
            color: var(--accent);
        }

        #preview tr:nth-child(even) {
            background: var(--bg-tertiary);
        }

        #preview ::selection {
            background: var(--accent-light);
            color: var(--text-primary);
        }

        #preview img {
            max-width: 100%;
            border-radius: 8px;
            margin: 1em 0;
        }

        #preview hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), var(--accent-light), transparent);
            margin: 2em 0;
        }

        /* Mermaid Container */
        .mermaid-container {
            position: relative;
            margin: 1.5em 0;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            overflow: visible;
        }

        .mermaid-container .mermaid {
            display: flex;
            justify-content: center;
        }

        .mermaid-container svg {
            display: block;
            margin: 0 auto;
        }

        .mermaid-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .mermaid-container:hover .mermaid-actions {
            opacity: 1;
        }

        .mermaid-action-btn {
            background: var(--accent);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .mermaid-action-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .mermaid-action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Lazy loading placeholders */
        .mermaid-placeholder,
        .math-placeholder {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .lazy-placeholder-text {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9em;
            opacity: 0.7;
        }

        .mermaid-placeholder .lazy-placeholder-text {
            font-family: monospace;
        }

        /* Status Bar */
        .status-bar {
            padding: 8px 20px;
            background: var(--bg-tertiary);
            border-top: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-item svg {
            width: 14px;
            height: 14px;
            color: var(--accent);
        }

        /* Hidden file input */
        #file-input {
            display: none;
        }

        /* Print Styles */
        @media print {
            body {
                height: auto !important;
                overflow: visible !important;
                background: white !important;
                color: black !important;
            }

            .toolbar, .editor-panel, .resizer, .status-bar, .mermaid-actions, .panel-header {
                display: none !important;
            }

            .main-container {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
            }

            .preview-panel {
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                position: static !important;
            }

            #preview {
                padding: 20px !important;
                overflow: visible !important;
                height: auto !important;
            }

            #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
                color: black !important;
            }

            #preview p, #preview li, #preview td, #preview th {
                color: #333 !important;
            }

            #preview pre, #preview code {
                background: #f5f5f5 !important;
                color: #333 !important;
            }

            #preview pre {
                border: 1px solid #ccc !important;
                white-space: pre-wrap !important;
                word-wrap: break-word !important;
            }

            #preview blockquote {
                border-left-color: #666 !important;
                background: #f9f9f9 !important;
                color: #333 !important;
            }

            #preview table {
                border-collapse: collapse !important;
            }

            #preview th, #preview td {
                border: 1px solid #ccc !important;
            }

            .mermaid-container {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                background: white !important;
                border: 1px solid #ccc !important;
            }

            .mermaid-container .mermaid,
            .mermaid-container .mermaid-cached {
                display: flex !important;
                justify-content: center !important;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            right: 24px;
            background: var(--accent);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 20px var(--shadow);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Dropdown menu */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 30px var(--shadow);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
        }

        .dropdown.open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-item:first-child {
            border-radius: 7px 7px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 7px 7px;
        }

        .dropdown-item:hover {
            background: var(--accent-light);
            color: var(--accent);
        }

        .dropdown-item:hover svg {
            color: var(--accent);
        }

        .dropdown-item svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
            transition: color 0.2s ease;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* Color Palette */
        .color-palette-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-palette-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .color-palette-btn svg {
            width: 22px;
            height: 22px;
            color: white;
        }

        .color-palette-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow);
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
            min-width: 200px;
        }

        .color-palette-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .color-palette-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .color-swatch {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.active {
            border-color: var(--text-primary);
        }

        .color-swatch.active::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .color-swatch[data-color="indigo"] { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .color-swatch[data-color="blue"] { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .color-swatch[data-color="emerald"] { background: linear-gradient(135deg, #10b981 0%, #047857 100%); }
        .color-swatch[data-color="rose"] { background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%); }
        .color-swatch[data-color="amber"] { background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%); }
        .color-swatch[data-color="cyan"] { background: linear-gradient(135deg, #06b6d4 0%, #0e7490 100%); }
        .color-swatch[data-color="violet"] { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); }
        .color-swatch[data-color="slate"] { background: linear-gradient(135deg, #64748b 0%, #334155 100%); }

        /* Indent Size Setting */
        .indent-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            height: 44px;
            padding: 0 12px;
            border-radius: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            position: relative;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .indent-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .indent-btn svg {
            width: 18px;
            height: 18px;
        }

        .indent-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
            min-width: 160px;
        }

        .indent-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .indent-popup-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .indent-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .indent-option {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-primary);
        }

        .indent-option:hover {
            background: var(--bg-hover);
        }

        .indent-option.active {
            background: var(--accent);
            color: white;
        }

        .indent-option.active::after {
            content: '✓';
            font-weight: bold;
        }

        /* Font Settings */
        .font-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            height: 44px;
            padding: 0 12px;
            border-radius: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            position: relative;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .font-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .font-btn svg {
            width: 18px;
            height: 18px;
        }

        .font-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
            min-width: 280px;
        }

        .font-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .font-popup-section {
            margin-bottom: 16px;
        }

        .font-popup-section:last-child {
            margin-bottom: 0;
        }

        .font-popup-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .font-popup-title svg {
            width: 14px;
            height: 14px;
            stroke: var(--text-muted);
        }

        .font-setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .font-setting-row:last-child {
            margin-bottom: 0;
        }

        .font-setting-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .font-select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            min-width: 130px;
        }

        .font-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-size-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .font-size-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .font-size-value {
            min-width: 50px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .font-divider {
            height: 1px;
            background: var(--border);
            margin: 12px 0;
        }

        /* Sample Code Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
        }

        .modal-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s ease;
        }

        .modal-tab:hover {
            color: var(--text-primary);
        }

        .modal-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .sample-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sample-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .sample-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
        }

        .sample-card-preview {
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .sample-card-preview .mermaid {
            font-size: 10px;
            transform: scale(0.6);
            transform-origin: center;
        }

        .sample-card-preview .katex {
            font-size: 0.9rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Language Popup */
        .lang-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow);
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
            min-width: 180px;
        }

        .lang-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-popup-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .lang-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lang-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .lang-item:hover {
            background: var(--accent-light);
        }

        .lang-item.active {
            background: var(--accent);
            color: white;
        }

        .lang-item-flag {
            font-size: 1.2rem;
        }

        .lang-item-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .lang-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            padding: 0 14px;
            gap: 6px;
        }

        .lang-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Math (KaTeX) Styles */
        .math-container {
            position: relative;
            margin: 1.5em 0;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            overflow: visible;
        }

        .math-container .math-content {
            display: flex;
            justify-content: center;
            overflow-x: auto;
        }

        .math-inline {
            display: inline;
            padding: 0 2px;
        }

        #preview .katex {
            font-size: 1.1em;
        }

        #preview .katex-display {
            margin: 0;
            padding: 0;
        }

        #preview .katex-display > .katex {
            font-size: 1.2em;
        }

        .math-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .math-container:hover .math-actions {
            opacity: 1;
        }

        .math-action-btn {
            background: var(--accent);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .math-action-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .math-action-btn svg {
            width: 14px;
            height: 14px;
        }

        @media print {
            .math-container {
                background: #f5f5f5 !important;
                border-left-color: #666 !important;
            }
            .math-actions {
                display: none !important;
            }
        }

    </style>
</head>
<body>
    <input type="file" id="file-input" accept=".md,.txt,.markdown,text/*">
    
    <div class="toolbar">
        <div class="toolbar-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <line x1="10" y1="9" x2="8" y2="9"/>
            </svg>
            Markdown Editor Pro
        </div>
        
        <div class="toolbar-group">
            <div class="dropdown" id="file-dropdown">
                <button class="toolbar-btn" onclick="toggleDropdown('file-dropdown')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                    </svg>
                    <span data-i18n="file">File</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;">
                        <polyline points="6,9 12,15 18,9"/>
                    </svg>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-item" onclick="newFile()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                            <line x1="12" y1="18" x2="12" y2="12"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        <span data-i18n="newFile">New</span>
                    </div>
                    <div class="dropdown-item" onclick="openFile()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span data-i18n="openFile">Open</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="saveFile()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                        <span data-i18n="save">Save</span>
                    </div>
                    <div class="dropdown-item" onclick="saveFileAs()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                        </svg>
                        <span data-i18n="saveAs">Save As</span>
                    </div>
                </div>
            </div>
            <span class="file-name" id="file-name-display">untitled.md</span>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" id="undo-btn" onclick="performUndo()" data-i18n-title="undo" title="Undo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 10h13a4 4 0 0 1 0 8H9"/>
                    <polyline points="7,6 3,10 7,14"/>
                </svg>
            </button>
            <button class="toolbar-btn" id="redo-btn" onclick="performRedo()" data-i18n-title="redo" title="Redo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10H8a4 4 0 0 0 0 8h7"/>
                    <polyline points="17,6 21,10 17,14"/>
                </svg>
            </button>
            <button class="toolbar-btn" onclick="printPreview()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 6,2 18,2 18,9"/>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                    <rect x="6" y="14" width="12" height="8"/>
                </svg>
                <span data-i18n="print">Print</span>
            </button>
            <button class="toolbar-btn" onclick="openSampleModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="9" y1="9" x2="15" y2="9"/>
                    <line x1="9" y1="13" x2="15" y2="13"/>
                    <line x1="9" y1="17" x2="12" y2="17"/>
                </svg>
                <span data-i18n="samples">Samples</span>
            </button>
        </div>

        <div class="spacer"></div>
        
        <!-- Language Selector -->
        <div style="position: relative;">
            <button class="lang-toggle" onclick="toggleLangPopup()" id="lang-toggle-btn">
                <span id="current-lang-flag">🌐</span>
                <span id="current-lang-code">EN</span>
            </button>
            <div class="lang-popup" id="lang-popup">
                <div class="lang-popup-title" data-i18n="language">Language</div>
                <div class="lang-list">
                    <div class="lang-item active" data-lang="en" onclick="setLanguage('en')">
                        <span class="lang-item-flag">🇺🇸</span>
                        <span class="lang-item-name">English</span>
                    </div>
                    <div class="lang-item" data-lang="ja" onclick="setLanguage('ja')">
                        <span class="lang-item-flag">🇯🇵</span>
                        <span class="lang-item-name">日本語</span>
                    </div>
                    <div class="lang-item" data-lang="zh" onclick="setLanguage('zh')">
                        <span class="lang-item-flag">🇨🇳</span>
                        <span class="lang-item-name">中文</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="position: relative;">
            <button class="color-palette-btn" onclick="toggleColorPalette()" data-i18n-title="colorTheme" title="Color Theme">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="4"/>
                    <line x1="12" y1="2" x2="12" y2="4"/>
                    <line x1="12" y1="20" x2="12" y2="22"/>
                    <line x1="2" y1="12" x2="4" y2="12"/>
                    <line x1="20" y1="12" x2="22" y2="12"/>
                </svg>
            </button>
            <div class="color-palette-popup" id="color-palette">
                <div class="color-palette-title" data-i18n="colorTheme">Color Theme</div>
                <div class="color-grid">
                    <div class="color-swatch active" data-color="indigo" onclick="setColorTheme('indigo')" title="Indigo"></div>
                    <div class="color-swatch" data-color="blue" onclick="setColorTheme('blue')" title="Blue"></div>
                    <div class="color-swatch" data-color="cyan" onclick="setColorTheme('cyan')" title="Cyan"></div>
                    <div class="color-swatch" data-color="emerald" onclick="setColorTheme('emerald')" title="Emerald"></div>
                    <div class="color-swatch" data-color="amber" onclick="setColorTheme('amber')" title="Amber"></div>
                    <div class="color-swatch" data-color="rose" onclick="setColorTheme('rose')" title="Rose"></div>
                    <div class="color-swatch" data-color="violet" onclick="setColorTheme('violet')" title="Violet"></div>
                    <div class="color-swatch" data-color="slate" onclick="setColorTheme('slate')" title="Slate"></div>
                </div>
            </div>
        </div>

        <div style="position: relative;">
            <button class="indent-btn" onclick="toggleIndentPopup()" data-i18n-title="indentSize" title="Indent Size">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="21" y1="6" x2="3" y2="6"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                    <line x1="21" y1="18" x2="9" y2="18"/>
                    <polyline points="5 10 3 12 5 14"/>
                </svg>
                <span id="current-indent-size">2</span>
            </button>
            <div class="indent-popup" id="indent-popup">
                <div class="indent-popup-title" data-i18n="indentSize">Indent Size</div>
                <div class="indent-options">
                    <div class="indent-option active" data-size="2" onclick="setIndentSize(2)">2 spaces</div>
                    <div class="indent-option" data-size="4" onclick="setIndentSize(4)">4 spaces</div>
                    <div class="indent-option" data-size="8" onclick="setIndentSize(8)">8 spaces</div>
                </div>
            </div>
        </div>

        <div style="position: relative;">
            <button class="font-btn" onclick="toggleFontPopup()" title="Font Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 7 4 4 20 4 20 7"/>
                    <line x1="9" y1="20" x2="15" y2="20"/>
                    <line x1="12" y1="4" x2="12" y2="20"/>
                </svg>
                <span>Aa</span>
            </button>
            <div class="font-popup" id="font-popup">
                <!-- Editor Font Settings -->
                <div class="font-popup-section">
                    <div class="font-popup-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16,18 22,12 16,6"/>
                            <polyline points="8,6 2,12 8,18"/>
                        </svg>
                        Editor
                    </div>
                    <div class="font-setting-row">
                        <span class="font-setting-label">Font</span>
                        <select class="font-select" id="editor-font-family" onchange="setEditorFontFamily(this.value)">
                            <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                            <option value="'Consolas', monospace">Consolas</option>
                            <option value="'Fira Code', monospace">Fira Code</option>
                            <option value="'Source Code Pro', monospace">Source Code Pro</option>
                            <option value="monospace">System Mono</option>
                        </select>
                    </div>
                    <div class="font-setting-row">
                        <span class="font-setting-label">Size</span>
                        <div class="font-size-control">
                            <button class="font-size-btn" onclick="adjustEditorFontSize(-1)">−</button>
                            <span class="font-size-value" id="editor-font-size-display">14px</span>
                            <button class="font-size-btn" onclick="adjustEditorFontSize(1)">+</button>
                        </div>
                    </div>
                </div>

                <div class="font-divider"></div>

                <!-- Preview Font Settings -->
                <div class="font-popup-section">
                    <div class="font-popup-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        Preview
                    </div>
                    <div class="font-setting-row">
                        <span class="font-setting-label">Font</span>
                        <select class="font-select" id="preview-font-family" onchange="setPreviewFontFamily(this.value)">
                            <option value="'Noto Sans JP', 'Noto Sans SC', sans-serif">Noto Sans</option>
                            <option value="'Segoe UI', sans-serif">Segoe UI</option>
                            <option value="'Helvetica Neue', Arial, sans-serif">Helvetica</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="system-ui, sans-serif">System UI</option>
                        </select>
                    </div>
                    <div class="font-setting-row">
                        <span class="font-setting-label">Size</span>
                        <div class="font-size-control">
                            <button class="font-size-btn" onclick="adjustPreviewFontSize(-1)">−</button>
                            <span class="font-size-value" id="preview-font-size-display">16px</span>
                            <button class="font-size-btn" onclick="adjustPreviewFontSize(1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="theme-toggle" onclick="toggleTheme()" data-i18n-title="darkLightMode" title="Dark/Light Mode">
            <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        </button>
    </div>
    
    <div class="main-container">
        <div class="editor-panel" id="editor-panel">
            <div class="panel-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="16,18 22,12 16,6"/>
                    <polyline points="8,6 2,12 8,18"/>
                </svg>
                <span data-i18n="editor">Editor</span>
            </div>
            <div id="editor-wrapper">
                <textarea id="editor" data-i18n-placeholder="editorPlaceholder" placeholder="Enter Markdown here..."></textarea>
            </div>
        </div>
        
        <div class="resizer" id="resizer"></div>
        
        <div class="preview-panel">
            <div class="panel-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <span data-i18n="preview">Preview</span>
            </div>
            <div id="preview"></div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                <polyline points="14,2 14,8 20,8"/>
            </svg>
            <span id="char-count">0</span> <span data-i18n="characters">characters</span>
        </div>
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"/>
                <line x1="8" y1="12" x2="21" y2="12"/>
                <line x1="8" y1="18" x2="21" y2="18"/>
                <line x1="3" y1="6" x2="3.01" y2="6"/>
                <line x1="3" y1="12" x2="3.01" y2="12"/>
                <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            <span id="line-count">0</span> <span data-i18n="lines">lines</span>
        </div>
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
            </svg>
            <span id="mermaid-count">0</span> <span data-i18n="diagrams">diagrams</span>
        </div>
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4z"/>
                <path d="M17 14v3h-3M14 20l6-6"/>
            </svg>
            <span id="math-count">0</span> <span data-i18n="equations">equations</span>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // ==================== Internationalization (i18n) ====================
        const translations = {
            en: {
                file: "File",
                newFile: "New",
                openFile: "Open",
                save: "Save",
                saveAs: "Save As",
                print: "Print",
                samples: "Samples",
                sampleCode: "Sample Code",
                mermaidDiagrams: "Mermaid Diagrams",
                mathFormulas: "Math Formulas",
                sampleInserted: "Sample inserted",
                undo: "Undo",
                redo: "Redo",
                nothingToUndo: "Nothing to undo",
                nothingToRedo: "Nothing to redo",
                editor: "Editor",
                preview: "Preview",
                editorPlaceholder: "Enter Markdown here...",
                characters: "characters",
                lines: "lines",
                diagrams: "diagrams",
                equations: "equations",
                language: "Language",
                colorTheme: "Color Theme",
                indentSize: "Indent Size",
                darkLightMode: "Dark/Light Mode",
                newFileCreated: "New file created",
                fileOpened: "Opened: ",
                fileSaved: "Saved",
                fileSavedAs: "Saved as: ",
                fileDownloaded: "Downloaded: ",
                unsavedChanges: "You have unsaved changes. Create new file anyway?",
                pngDownloaded: "PNG downloaded",
                svgDownloaded: "SVG downloaded",
                pngExportFailed: "Failed to export PNG",
                svgNotFound: "SVG element not found",
                diagramNotFound: "Diagram not found",
                equationNotFound: "Equation not found",
                fileReadFailed: "Failed to read file",
                colorThemeChanged: "Color theme changed",
                sampleMarkdown: `# Welcome to Markdown Editor Pro!

This editor supports **Markdown** and **Mermaid diagrams**.

## Basic Formatting

Text can be **bold** or *italic*. You can also use \`inline code\`.

### Lists

- Item 1
- Item 2
  - Nested item
- Item 3

### Numbered List

1. First step
2. Second step
3. Final step

## Code Block

\`\`\`javascript
function greeting(name) {
    console.log(\`Hello, \${name}!\`);
}

greeting('World');
\`\`\`

## Blockquote

> This is a blockquote.
> It can span multiple lines.

## Table

| Feature | Status | Description |
|---------|--------|-------------|
| Markdown | ✅ | Full support |
| Mermaid | ✅ | Diagram creation |
| Math | ✅ | LaTeX equations |
| Dark Mode | ✅ | Theme toggle |

---

## Math Equations (LaTeX)

### Inline Math

The quadratic formula is $x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$ which solves $ax^2 + bx + c = 0$.

Einstein's famous equation: $E = mc^2$

### Block Math

The Gaussian integral:

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

Euler's identity:

$$e^{i\\pi} + 1 = 0$$

Matrix example:

$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax + by \\\\ cx + dy \\end{pmatrix}$$

Summation notation:

$$\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}$$

---

## Mermaid Diagrams

### Flowchart

\`\`\`mermaid
flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Process A]
    B -->|No| D[Process B]
    C --> E[End]
    D --> E
\`\`\`

### Sequence Diagram

\`\`\`mermaid
sequenceDiagram
    User->>Browser: Access URL
    Browser->>Server: HTTP Request
    Server->>Database: Fetch Data
    Database-->>Server: Return Data
    Server-->>Browser: HTML Response
    Browser-->>User: Display Page
\`\`\`

### Class Diagram

\`\`\`mermaid
classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat
\`\`\`

### Pie Chart

\`\`\`mermaid
pie title Project Progress
    "Completed" : 45
    "In Progress" : 30
    "Not Started" : 25
\`\`\`

---

## Tips

1. **File Operations**: Use the File menu to open/save files
2. **Resize Panels**: Drag the center bar to resize
3. **Export Diagrams**: Hover over diagrams for PNG/SVG buttons
4. **Print**: Only the preview is printed
5. **Theme**: Toggle dark/light mode with the button in the top right

Enjoy! 🚀
`
            },
            ja: {
                file: "ファイル",
                newFile: "新規作成",
                openFile: "開く",
                save: "上書き保存",
                saveAs: "名前を付けて保存",
                print: "印刷",
                samples: "サンプル",
                sampleCode: "サンプルコード",
                mermaidDiagrams: "Mermaid図",
                mathFormulas: "数式",
                sampleInserted: "サンプルを挿入しました",
                undo: "元に戻す",
                redo: "やり直す",
                nothingToUndo: "元に戻す操作がありません",
                nothingToRedo: "やり直す操作がありません",
                editor: "エディタ",
                preview: "プレビュー",
                editorPlaceholder: "Markdownを入力してください...",
                characters: "文字",
                lines: "行",
                diagrams: "図",
                equations: "数式",
                language: "言語",
                colorTheme: "カラーテーマ",
                indentSize: "インデント幅",
                darkLightMode: "ダーク/ライトモード",
                newFileCreated: "新規ファイルを作成しました",
                fileOpened: "開きました: ",
                fileSaved: "保存しました",
                fileSavedAs: "保存しました: ",
                fileDownloaded: "ダウンロードしました: ",
                unsavedChanges: "保存されていない変更があります。新規作成しますか？",
                pngDownloaded: "PNGをダウンロードしました",
                svgDownloaded: "SVGをダウンロードしました",
                pngExportFailed: "PNGのエクスポートに失敗しました",
                svgNotFound: "SVG要素が見つかりません",
                diagramNotFound: "図が見つかりません",
                equationNotFound: "数式が見つかりません",
                fileReadFailed: "ファイルの読み込みに失敗しました",
                colorThemeChanged: "カラーテーマを変更しました",
                sampleMarkdown: `# Markdown Editor Pro へようこそ！

このエディタは **Markdown** と **Mermaid図** をサポートしています。

## 基本的な書式

テキストは **太字** や *斜体* にできます。また、\`インラインコード\` も使えます。

### リスト

- 項目1
- 項目2
  - ネストされた項目
- 項目3

### 番号付きリスト

1. 最初のステップ
2. 次のステップ
3. 最後のステップ

## コードブロック

\`\`\`javascript
function greeting(name) {
    console.log(\`Hello, \${name}!\`);
}

greeting('World');
\`\`\`

## 引用

> これは引用ブロックです。
> 複数行にわたることができます。

## テーブル

| 機能 | 状態 | 説明 |
|------|------|------|
| Markdown | ✅ | 完全サポート |
| Mermaid | ✅ | 図表作成 |
| 数式 | ✅ | LaTeX数式 |
| ダークモード | ✅ | テーマ切替 |

---

## 数式 (LaTeX)

### インライン数式

二次方程式の解の公式は $x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$ で、$ax^2 + bx + c = 0$ を解きます。

アインシュタインの有名な方程式: $E = mc^2$

### ブロック数式

ガウス積分:

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

オイラーの等式:

$$e^{i\\pi} + 1 = 0$$

行列の例:

$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax + by \\\\ cx + dy \\end{pmatrix}$$

総和記号:

$$\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}$$

---

## Mermaid 図表

### フローチャート

\`\`\`mermaid
flowchart TD
    A[開始] --> B{条件分岐}
    B -->|Yes| C[処理A]
    B -->|No| D[処理B]
    C --> E[終了]
    D --> E
\`\`\`

### シーケンス図

\`\`\`mermaid
sequenceDiagram
    User->>Browser: URLにアクセス
    Browser->>Server: HTTPリクエスト
    Server->>Database: データ取得
    Database-->>Server: データ返却
    Server-->>Browser: HTMLレスポンス
    Browser-->>User: ページ表示
\`\`\`

### クラス図

\`\`\`mermaid
classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat
\`\`\`

### 円グラフ

\`\`\`mermaid
pie title プロジェクトの進捗
    "完了" : 45
    "進行中" : 30
    "未着手" : 25
\`\`\`

---

## 使い方のヒント

1. **ファイル操作**: ツールバーの「ファイル」メニューから開く・保存ができます
2. **リサイズ**: 中央のバーをドラッグしてパネルサイズを変更
3. **Mermaid図のエクスポート**: 図にマウスを乗せると PNG/SVG ボタンが表示されます
4. **印刷**: プレビュー部分のみが印刷されます
5. **テーマ**: 右上のボタンでダーク/ライトモードを切替

お楽しみください！ 🚀
`
            },
            zh: {
                file: "文件",
                newFile: "新建",
                openFile: "打开",
                save: "保存",
                saveAs: "另存为",
                print: "打印",
                samples: "示例",
                sampleCode: "示例代码",
                mermaidDiagrams: "Mermaid 图表",
                mathFormulas: "数学公式",
                sampleInserted: "已插入示例",
                undo: "撤销",
                redo: "重做",
                nothingToUndo: "没有可撤销的操作",
                nothingToRedo: "没有可重做的操作",
                editor: "编辑器",
                preview: "预览",
                editorPlaceholder: "在此输入 Markdown...",
                characters: "字符",
                lines: "行",
                diagrams: "图表",
                equations: "公式",
                language: "语言",
                colorTheme: "颜色主题",
                indentSize: "缩进大小",
                darkLightMode: "深色/浅色模式",
                newFileCreated: "已创建新文件",
                fileOpened: "已打开: ",
                fileSaved: "已保存",
                fileSavedAs: "已保存为: ",
                fileDownloaded: "已下载: ",
                unsavedChanges: "有未保存的更改。确定要新建文件吗？",
                pngDownloaded: "PNG 已下载",
                svgDownloaded: "SVG 已下载",
                pngExportFailed: "PNG 导出失败",
                svgNotFound: "未找到 SVG 元素",
                diagramNotFound: "未找到图表",
                equationNotFound: "未找到公式",
                fileReadFailed: "文件读取失败",
                colorThemeChanged: "颜色主题已更改",
                sampleMarkdown: `# 欢迎使用 Markdown Editor Pro！

本编辑器支持 **Markdown** 和 **Mermaid 图表**。

## 基本格式

文本可以设置为 **粗体** 或 *斜体*。还可以使用 \`行内代码\`。

### 列表

- 项目 1
- 项目 2
  - 嵌套项目
- 项目 3

### 有序列表

1. 第一步
2. 第二步
3. 最后一步

## 代码块

\`\`\`javascript
function greeting(name) {
    console.log(\`Hello, \${name}!\`);
}

greeting('World');
\`\`\`

## 引用

> 这是一个引用块。
> 可以跨越多行。

## 表格

| 功能 | 状态 | 描述 |
|------|------|------|
| Markdown | ✅ | 完全支持 |
| Mermaid | ✅ | 图表创建 |
| 数学公式 | ✅ | LaTeX公式 |
| 深色模式 | ✅ | 主题切换 |

---

## 数学公式 (LaTeX)

### 行内公式

二次方程的求根公式是 $x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$，用于求解 $ax^2 + bx + c = 0$。

爱因斯坦的著名方程：$E = mc^2$

### 块级公式

高斯积分：

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

欧拉恒等式：

$$e^{i\\pi} + 1 = 0$$

矩阵示例：

$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax + by \\\\ cx + dy \\end{pmatrix}$$

求和符号：

$$\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}$$

---

## Mermaid 图表

### 流程图

\`\`\`mermaid
flowchart TD
    A[开始] --> B{条件判断}
    B -->|是| C[处理 A]
    B -->|否| D[处理 B]
    C --> E[结束]
    D --> E
\`\`\`

### 时序图

\`\`\`mermaid
sequenceDiagram
    User->>Browser: 访问 URL
    Browser->>Server: HTTP 请求
    Server->>Database: 获取数据
    Database-->>Server: 返回数据
    Server-->>Browser: HTML 响应
    Browser-->>User: 显示页面
\`\`\`

### 类图

\`\`\`mermaid
classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat
\`\`\`

### 饼图

\`\`\`mermaid
pie title 项目进度
    "已完成" : 45
    "进行中" : 30
    "未开始" : 25
\`\`\`

---

## 使用提示

1. **文件操作**：使用文件菜单打开/保存文件
2. **调整大小**：拖动中间分隔条调整面板大小
3. **导出图表**：将鼠标悬停在图表上可显示 PNG/SVG 按钮
4. **打印**：仅打印预览部分
5. **主题**：点击右上角按钮切换深色/浅色模式

祝您使用愉快！ 🚀
`
            }
        };

        const langConfig = {
            en: { flag: '🇺🇸', code: 'EN' },
            ja: { flag: '🇯🇵', code: 'JA' },
            zh: { flag: '🇨🇳', code: 'ZH' }
        };

        let currentLang = 'en';

        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        function updateUILanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                el.title = t(key);
            });
            const config = langConfig[currentLang];
            document.getElementById('current-lang-flag').textContent = config.flag;
            document.getElementById('current-lang-code').textContent = config.code;
            document.querySelectorAll('.lang-item').forEach(item => {
                item.classList.toggle('active', item.dataset.lang === currentLang);
            });
            document.documentElement.lang = currentLang;
        }

        function setLanguage(lang, updateContent = true) {
            const previousLang = currentLang;
            currentLang = lang;
            updateUILanguage();
            if (updateContent) {
                const editorContent = editor.value.trim();
                const isDefaultContent = Object.values(translations).some(
                    t => editorContent === t.sampleMarkdown.trim()
                );
                if (!editorContent || isDefaultContent) {
                    editor.value = t('sampleMarkdown');
                    updatePreview();
                }
            }
            localStorage.setItem('language', lang);
            document.getElementById('lang-popup').classList.remove('open');
        }

        function toggleLangPopup() {
            document.getElementById('lang-popup').classList.toggle('open');
            document.getElementById('color-palette').classList.remove('open');
        }

        // State
        let currentFileName = 'untitled.md';
        let fileHandle = null;
        let isDirty = false;
        let mermaidCounter = 0;

        // Undo/Redo state (unlimited history)
        let undoStack = [];
        let redoStack = [];
        let isUndoRedo = false;
        let lastSavedState = null;
        const DEBOUNCE_DELAY = 300; // ms
        let debounceTimer = null;

        // DOM Elements
        const editorTextarea = document.getElementById('editor');
        const editorWrapper = document.getElementById('editor-wrapper');
        const preview = document.getElementById('preview');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const charCount = document.getElementById('char-count');
        const lineCount = document.getElementById('line-count');
        const mermaidCount = document.getElementById('mermaid-count');
        const resizer = document.getElementById('resizer');
        const editorPanel = document.getElementById('editor-panel');

        // CodeMirror instance
        let cmEditor = null;

        // Editor proxy object for backward compatibility
        const editor = {
            get value() {
                return cmEditor ? cmEditor.getValue() : editorTextarea.value;
            },
            set value(val) {
                if (cmEditor) {
                    cmEditor.setValue(val);
                } else {
                    editorTextarea.value = val;
                }
            },
            get selectionStart() {
                if (cmEditor) {
                    const cursor = cmEditor.getCursor('start');
                    return cmEditor.indexFromPos(cursor);
                }
                return editorTextarea.selectionStart;
            },
            set selectionStart(val) {
                if (cmEditor) {
                    const pos = cmEditor.posFromIndex(val);
                    cmEditor.setCursor(pos);
                } else {
                    editorTextarea.selectionStart = val;
                }
            },
            get selectionEnd() {
                if (cmEditor) {
                    const cursor = cmEditor.getCursor('end');
                    return cmEditor.indexFromPos(cursor);
                }
                return editorTextarea.selectionEnd;
            },
            set selectionEnd(val) {
                // For CodeMirror, we typically set selection using setSelection
            },
            setSelectionRange(start, end) {
                if (cmEditor) {
                    const startPos = cmEditor.posFromIndex(start);
                    const endPos = cmEditor.posFromIndex(end);
                    cmEditor.setSelection(startPos, endPos);
                    cmEditor.focus();
                } else {
                    editorTextarea.setSelectionRange(start, end);
                }
            },
            focus() {
                if (cmEditor) {
                    cmEditor.focus();
                } else {
                    editorTextarea.focus();
                }
            },
            blur() {
                if (cmEditor) {
                    cmEditor.getInputField().blur();
                } else {
                    editorTextarea.blur();
                }
            }
        };

        // Pre-analyzed line information for block math and mermaid
        let blockMathLines = new Set(); // Lines that are inside $$ blocks (not including delimiter lines)
        let mermaidLines = new Set();   // Lines that are inside ```mermaid blocks

        // Analyze full text to find block math and mermaid regions
        function analyzeBlockRegions(text) {
            const lines = text.split('\n');
            const newBlockMathLines = new Set();
            const newMermaidLines = new Set();

            let inBlockMath = false;
            let blockMathStart = -1;
            let inMermaid = false;
            let inCodeBlock = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Check for code block start/end
                if (line.startsWith('```')) {
                    if (!inCodeBlock) {
                        inCodeBlock = true;
                        if (line.match(/^```mermaid/i)) {
                            inMermaid = true;
                        }
                    } else {
                        inCodeBlock = false;
                        inMermaid = false;
                    }
                    continue;
                }

                // Mark mermaid lines (content lines, not the ``` markers)
                if (inMermaid) {
                    newMermaidLines.add(i);
                }

                // Skip math detection inside code blocks
                if (inCodeBlock) continue;

                // Check for $$ delimiter
                if (line === '$$') {
                    if (!inBlockMath) {
                        inBlockMath = true;
                        blockMathStart = i;
                    } else {
                        // End of block math - mark all lines between start and end
                        for (let j = blockMathStart + 1; j < i; j++) {
                            newBlockMathLines.add(j);
                        }
                        inBlockMath = false;
                        blockMathStart = -1;
                    }
                }
            }

            blockMathLines = newBlockMathLines;
            mermaidLines = newMermaidLines;
        }

        // Define math/mermaid overlay with pre-analyzed line info
        CodeMirror.defineMode('gfm-math', function(config) {
            const gfmMode = CodeMirror.getMode(config, 'gfm');

            const mathOverlay = {
                token: function(stream, state) {
                    const lineNo = stream.lineOracle ? stream.lineOracle.line : -1;

                    // If this line is inside a block math region, highlight everything
                    if (blockMathLines.has(lineNo)) {
                        stream.skipToEnd();
                        return 'math-block';
                    }

                    // If this line is inside a mermaid block, highlight everything
                    if (mermaidLines.has(lineNo)) {
                        stream.skipToEnd();
                        return 'mermaid-code';
                    }

                    // Match $$ - check if it's inline block math ($$...$$) on same line
                    if (stream.match(/^\$\$/)) {
                        // Look ahead for closing $$ on same line
                        const rest = stream.string.slice(stream.pos);
                        const closingMatch = rest.indexOf('$$');
                        if (closingMatch >= 0) {
                            // Found closing $$ - consume content and closing delimiter
                            for (let i = 0; i < closingMatch + 2; i++) {
                                stream.next();
                            }
                            return 'math-block';
                        }
                        // No closing $$ on same line - just mark as delimiter
                        return 'math-delimiter';
                    }

                    // Match inline math $...$ (single line only, not $$)
                    if (stream.match(/^\$(?!\$)/)) {
                        // Look for closing $ on same line
                        let ch;
                        while ((ch = stream.next()) != null) {
                            if (ch === '$' && stream.peek() !== '$') {
                                return 'math-inline';
                            }
                            if (ch === '\\' && stream.peek()) {
                                stream.next(); // skip escaped char
                            }
                        }
                        // No closing $ found, return null (no highlight)
                        return null;
                    }

                    // Skip to next potential marker
                    while (stream.next() != null) {
                        if (stream.peek() === '$') break;
                    }
                    return null;
                }
            };

            return CodeMirror.overlayMode(gfmMode, mathOverlay);
        });

        // Initialize CodeMirror
        function initCodeMirror() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';

            const savedIndentSize = parseInt(localStorage.getItem('indentSize')) || 2;

            cmEditor = CodeMirror.fromTextArea(editorTextarea, {
                mode: 'gfm-math', // GFM with math highlighting
                theme: isDark ? 'material-darker' : 'default',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: savedIndentSize,
                tabSize: savedIndentSize,
                indentWithTabs: false,
                autoCloseBrackets: true,
                matchBrackets: true,
                styleActiveLine: true,
                placeholder: t('editorPlaceholder'),
                extraKeys: {
                    'Tab': (cm) => {
                        if (cm.somethingSelected()) {
                            cm.indentSelection('add');
                        } else {
                            cm.replaceSelection(' '.repeat(cm.getOption('indentUnit')), 'end');
                        }
                    },
                    'Shift-Tab': (cm) => {
                        cm.indentSelection('subtract');
                    }
                }
            });

            // Set initial content
            cmEditor.setValue(t('sampleMarkdown'));

            // Initial analysis for block highlighting
            analyzeBlockRegions(cmEditor.getValue());

            // Handle input events for preview update
            let refreshPending = false;
            cmEditor.on('change', () => {
                // Analyze block regions for highlighting
                const oldMathLines = new Set(blockMathLines);
                const oldMermaidLines = new Set(mermaidLines);
                analyzeBlockRegions(cmEditor.getValue());

                // Check if block regions changed - if so, refresh highlighting
                const mathChanged = blockMathLines.size !== oldMathLines.size ||
                    [...blockMathLines].some(l => !oldMathLines.has(l));
                const mermaidChanged = mermaidLines.size !== oldMermaidLines.size ||
                    [...mermaidLines].some(l => !oldMermaidLines.has(l));

                if ((mathChanged || mermaidChanged) && !refreshPending) {
                    refreshPending = true;
                    requestAnimationFrame(() => {
                        // Force re-tokenization by setting the mode again
                        cmEditor.setOption('mode', cmEditor.getOption('mode'));
                        refreshPending = false;
                    });
                }

                schedulePreviewUpdate();
                updateStats();
            });

            // Apply saved font settings
            const savedFontFamily = localStorage.getItem('editorFontFamily');
            const savedFontSize = localStorage.getItem('editorFontSize');
            if (savedFontFamily) {
                cmEditor.getWrapperElement().style.fontFamily = savedFontFamily;
            }
            if (savedFontSize) {
                cmEditor.getWrapperElement().style.fontSize = savedFontSize + 'px';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved language preference (default: English)
            const savedLang = localStorage.getItem('language') || 'en';
            currentLang = savedLang;
            updateUILanguage();

            // Check for saved theme preference BEFORE CodeMirror init
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            }

            // Check for saved color theme
            const savedColor = localStorage.getItem('colorTheme') || 'indigo';
            setColorTheme(savedColor, false);

            // Initialize CodeMirror (after theme is set)
            initCodeMirror();

            updatePreview();
            updateStats();
            initResizer();

            // Initialize indent size from localStorage
            initIndentSize();

            // Initialize undo/redo
            initUndoRedo();

            // Initialize font settings
            initFontSettings();

            updateMermaidTheme();
        });

        // Marked configuration
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            editor.value = t('sampleMarkdown');
            updatePreview();
            updateStats();
            initResizer();
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            }
            
            // Check for saved color theme
            const savedColor = localStorage.getItem('colorTheme') || 'indigo';
            setColorTheme(savedColor, false);
            
            updateMermaidTheme();
        });

        // Undo/Redo Functions
        function saveState() {
            if (isUndoRedo) return;

            const currentState = {
                content: editor.value,
                selectionStart: editor.selectionStart,
                selectionEnd: editor.selectionEnd
            };

            // Don't save if content hasn't changed
            if (lastSavedState && lastSavedState.content === currentState.content) {
                return;
            }

            undoStack.push(currentState);
            redoStack = []; // Clear redo stack on new action
            lastSavedState = currentState;
            updateUndoRedoButtons();
        }

        function saveStateDebounced() {
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            debounceTimer = setTimeout(() => {
                saveState();
            }, DEBOUNCE_DELAY);
        }

        function performUndo() {
            if (undoStack.length === 0) {
                showToast(t('nothingToUndo'));
                return;
            }

            // Save current state to redo stack
            const currentState = {
                content: editor.value,
                selectionStart: editor.selectionStart,
                selectionEnd: editor.selectionEnd
            };
            redoStack.push(currentState);

            // Restore previous state
            const prevState = undoStack.pop();
            isUndoRedo = true;
            editor.value = prevState.content;
            editor.selectionStart = prevState.selectionStart;
            editor.selectionEnd = prevState.selectionEnd;
            lastSavedState = prevState;
            isUndoRedo = false;

            updatePreview();
            updateStats();
            updateUndoRedoButtons();
        }

        function performRedo() {
            if (redoStack.length === 0) {
                showToast(t('nothingToRedo'));
                return;
            }

            // Save current state to undo stack
            const currentState = {
                content: editor.value,
                selectionStart: editor.selectionStart,
                selectionEnd: editor.selectionEnd
            };
            undoStack.push(currentState);

            // Restore next state
            const nextState = redoStack.pop();
            isUndoRedo = true;
            editor.value = nextState.content;
            editor.selectionStart = nextState.selectionStart;
            editor.selectionEnd = nextState.selectionEnd;
            lastSavedState = nextState;
            isUndoRedo = false;

            updatePreview();
            updateStats();
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');

            if (undoBtn) {
                undoBtn.style.opacity = undoStack.length > 0 ? '1' : '0.5';
            }
            if (redoBtn) {
                redoBtn.style.opacity = redoStack.length > 0 ? '1' : '0.5';
            }
        }

        function initUndoRedo() {
            // Save initial state
            lastSavedState = {
                content: editor.value,
                selectionStart: 0,
                selectionEnd: 0
            };
            updateUndoRedoButtons();
        }

        // Scroll textarea to keep cursor visible
        function scrollCursorIntoView() {
            const cursorPos = editor.selectionStart;

            // Force browser to recalculate and show cursor by refocusing
            requestAnimationFrame(() => {
                // Blur and refocus to force cursor redraw
                editor.blur();
                editor.focus();

                // Restore cursor position and trigger native scroll behavior
                editor.setSelectionRange(cursorPos, cursorPos);
            });
        }

        // Preview update scheduling with requestIdleCallback + requestAnimationFrame
        let previewUpdatePending = false;
        let previewIdleCallbackId = null;
        const useIdleCallback = 'requestIdleCallback' in window;

        function schedulePreviewUpdate() {
            // If update is already pending, skip (coalesce multiple calls)
            if (previewUpdatePending) return;
            previewUpdatePending = true;

            // Two-phase scheduling:
            // 1. Wait for browser idle time (requestIdleCallback)
            // 2. Sync with next paint frame (requestAnimationFrame)
            function executeUpdate() {
                // Use requestAnimationFrame to sync with browser's paint cycle
                requestAnimationFrame(() => {
                    previewUpdatePending = false;
                    previewIdleCallbackId = null;
                    updatePreview();
                });
            }

            // Use requestIdleCallback for non-blocking preview updates
            // Falls back to setTimeout for Safari compatibility
            if (useIdleCallback) {
                previewIdleCallbackId = requestIdleCallback(executeUpdate, { timeout: 500 }); // Max 500ms wait
            } else {
                // Fallback for Safari
                previewIdleCallbackId = setTimeout(executeUpdate, 100);
            }
        }

        // Editor input handler - for non-CodeMirror fallback only
        // (CodeMirror handles its own events via cmEditor.on('change', ...))

        // Global keyboard shortcuts (work with or without CodeMirror)
        document.addEventListener('keydown', (e) => {
            // Keyboard shortcuts
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    saveFile();
                } else if (e.key === 'o') {
                    e.preventDefault();
                    openFile();
                }
            }
        });

        // Update preview
        let mathBlockCounter = 0;

        // Cache for Mermaid diagrams - key is the code hash, value is SVG
        const mermaidCache = new Map(); // code -> svg

        // Cache for KaTeX math - key is the code hash, value is rendered HTML
        const mathCache = new Map(); // code -> html

        // Intersection Observer for lazy rendering
        let lazyRenderObserver = null;

        function initLazyRenderObserver() {
            if (lazyRenderObserver) {
                lazyRenderObserver.disconnect();
            }

            lazyRenderObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;

                        if (el.classList.contains('mermaid-lazy')) {
                            // Render mermaid diagram
                            renderLazyMermaid(el);
                        } else if (el.classList.contains('math-lazy')) {
                            // Render math equation
                            renderLazyMath(el);
                        }

                        // Stop observing once rendered
                        lazyRenderObserver.unobserve(el);
                    }
                });
            }, {
                root: preview,
                rootMargin: '100px', // Start rendering slightly before entering viewport
                threshold: 0
            });
        }

        async function renderLazyMermaid(el) {
            const code = el.getAttribute('data-mermaid-code');
            const hash = el.getAttribute('data-hash');

            if (!code) return;

            el.textContent = decodeURIComponent(code);
            el.classList.remove('mermaid-lazy');
            el.classList.add('mermaid');

            try {
                await mermaid.run({ nodes: [el] });

                // Cache the rendered SVG
                if (hash && el.innerHTML.includes('<svg')) {
                    mermaidCache.set(hash, el.innerHTML);
                }
            } catch (error) {
                console.error('Mermaid lazy rendering error:', error);
            }
        }

        function renderLazyMath(el) {
            const mathSrc = decodeURIComponent(el.getAttribute('data-math-src') || '');
            const hash = el.getAttribute('data-math-hash');
            const isBlock = el.classList.contains('math-content');

            if (!mathSrc) return;

            try {
                const rendered = katex.renderToString(mathSrc, {
                    displayMode: isBlock,
                    throwOnError: false,
                    errorColor: '#cc0000'
                });
                el.innerHTML = rendered;
                el.classList.remove('math-lazy', 'math-to-render');
                el.classList.add('math-cached');

                // Cache the rendered HTML
                if (hash) {
                    mathCache.set(hash, rendered);
                }
            } catch (error) {
                console.error('KaTeX lazy rendering error:', error);
            }
        }

        // Simple hash function for caching
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString();
        }

        async function updatePreview() {
            // Save scroll position before update
            const scrollTop = preview.scrollTop;
            const scrollHeight = preview.scrollHeight;
            const clientHeight = preview.clientHeight;
            const wasAtBottom = scrollTop + clientHeight >= scrollHeight - 10;

            let content = editor.value;
            mermaidCounter = 0;
            mathBlockCounter = 0;
            let mathCounter = 0;

            // Protect code blocks from math processing
            const codeBlocks = [];
            content = content.replace(/```[\s\S]*?```/g, (match) => {
                const placeholder = `%%CODEBLOCK_${codeBlocks.length}%%`;
                codeBlocks.push(match);
                return placeholder;
            });

            // Protect inline code from math processing
            const inlineCodes = [];
            content = content.replace(/`[^`]+`/g, (match) => {
                const placeholder = `%%INLINECODE_${inlineCodes.length}%%`;
                inlineCodes.push(match);
                return placeholder;
            });

            // Process block math ($$...$$) - count them and add download buttons
            const blockMathMatches = content.match(/\$\$[\s\S]*?\$\$/g) || [];
            mathCounter += blockMathMatches.length;
            content = content.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                const id = `math-${mathBlockCounter++}`;
                const trimmedMath = math.trim();
                const mathHash = hashCode(trimmedMath + '_block');
                const cachedHtml = mathCache.get(mathHash);

                if (cachedHtml) {
                    // Use cached rendered math
                    return `<div class="math-container" data-math-id="${id}">
                        <div class="math-actions">
                            <button class="math-action-btn" onclick="downloadMathPNG('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21,15 16,10 5,21"/>
                                </svg>
                                PNG
                            </button>
                            <button class="math-action-btn" onclick="downloadMathSVG('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                    <polyline points="2,17 12,22 22,17"/>
                                    <polyline points="2,12 12,17 22,12"/>
                                </svg>
                                SVG
                            </button>
                        </div>
                        <div class="math-content math-cached" id="${id}">${cachedHtml}</div>
                    </div>`;
                }

                return `<div class="math-container" data-math-id="${id}">
                    <div class="math-actions">
                        <button class="math-action-btn" onclick="downloadMathPNG('${id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21,15 16,10 5,21"/>
                            </svg>
                            PNG
                        </button>
                        <button class="math-action-btn" onclick="downloadMathSVG('${id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                <polyline points="2,17 12,22 22,17"/>
                                <polyline points="2,12 12,17 22,12"/>
                            </svg>
                            SVG
                        </button>
                    </div>
                    <div class="math-content math-lazy math-placeholder" id="${id}" data-math-hash="${mathHash}" data-math-src="${encodeURIComponent(trimmedMath)}">
                        <div class="lazy-placeholder-text">$$${math}$$</div>
                    </div>
                </div>`;
            });

            // Process inline math ($...$) - count them (but not $$)
            const inlineMathMatches = content.match(/(?<!\$)\$(?!\$)([^\$\n]+?)\$(?!\$)/g) || [];
            mathCounter += inlineMathMatches.length;
            content = content.replace(/(?<!\$)\$(?!\$)([^\$\n]+?)\$(?!\$)/g, (match, math) => {
                const trimmedMath = math.trim();
                const mathHash = hashCode(trimmedMath + '_inline');
                const cachedHtml = mathCache.get(mathHash);

                if (cachedHtml) {
                    return `<span class="math-inline math-cached">${cachedHtml}</span>`;
                }

                return `<span class="math-inline math-lazy" data-math-hash="${mathHash}" data-math-src="${encodeURIComponent(trimmedMath)}">$${math}$</span>`;
            });

            // Restore inline code
            inlineCodes.forEach((code, index) => {
                content = content.replace(`%%INLINECODE_${index}%%`, code);
            });

            // Restore code blocks
            codeBlocks.forEach((code, index) => {
                content = content.replace(`%%CODEBLOCK_${index}%%`, code);
            });

            // Process mermaid code blocks - extract and track for caching
            const mermaidRegex = /```mermaid\n([\s\S]*?)```/g;
            const mermaidBlocks = [];
            const mermaidCodeToRender = []; // { id, code, hash }
            let match;

            while ((match = mermaidRegex.exec(content)) !== null) {
                mermaidBlocks.push(match[1]);
            }

            // Replace mermaid blocks with placeholders
            content = content.replace(mermaidRegex, (match, code) => {
                const id = `mermaid-${mermaidCounter++}`;
                const trimmedCode = code.trim();
                const codeHash = hashCode(trimmedCode);

                // Check if we have a cached version (by code content, not by id)
                const cachedSvg = mermaidCache.get(codeHash);
                if (cachedSvg) {
                    // Use cached SVG
                    return `<div class="mermaid-container" data-mermaid-id="${id}">
                        <div class="mermaid-actions">
                            <button class="mermaid-action-btn" onclick="downloadMermaidPNG('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21,15 16,10 5,21"/>
                                </svg>
                                PNG
                            </button>
                            <button class="mermaid-action-btn" onclick="downloadMermaidSVG('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                    <polyline points="2,17 12,22 22,17"/>
                                    <polyline points="2,12 12,17 22,12"/>
                                </svg>
                                SVG
                            </button>
                        </div>
                        <div class="mermaid-cached" id="${id}">${cachedSvg}</div>
                    </div>`;
                }

                // Not cached, need to render (mark as lazy for Intersection Observer)
                mermaidCodeToRender.push({ id, code: trimmedCode, hash: codeHash });

                return `<div class="mermaid-container" data-mermaid-id="${id}">
                    <div class="mermaid-actions">
                        <button class="mermaid-action-btn" onclick="downloadMermaidPNG('${id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21,15 16,10 5,21"/>
                            </svg>
                            PNG
                        </button>
                        <button class="mermaid-action-btn" onclick="downloadMermaidSVG('${id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                <polyline points="2,17 12,22 22,17"/>
                                <polyline points="2,12 12,17 22,12"/>
                            </svg>
                            SVG
                        </button>
                    </div>
                    <div class="mermaid-lazy mermaid-placeholder" id="${id}" data-hash="${codeHash}" data-mermaid-code="${encodeURIComponent(trimmedCode)}">
                        <div class="lazy-placeholder-text">Loading diagram...</div>
                    </div>
                </div>`;
            });

            // Parse markdown
            preview.innerHTML = marked.parse(content);

            // Initialize lazy render observer
            initLazyRenderObserver();

            // Helper function to check if element is in viewport
            function isInViewport(el) {
                const rect = el.getBoundingClientRect();
                const previewRect = preview.getBoundingClientRect();
                return (
                    rect.top < previewRect.bottom + 100 && // 100px margin
                    rect.bottom > previewRect.top - 100
                );
            }

            // Process mermaid diagrams - render visible ones immediately, lazy-load others
            const lazyMermaids = preview.querySelectorAll('.mermaid-lazy');
            const visibleMermaids = [];
            const offscreenMermaids = [];

            lazyMermaids.forEach(el => {
                if (isInViewport(el)) {
                    visibleMermaids.push(el);
                } else {
                    offscreenMermaids.push(el);
                }
            });

            // Render visible mermaid diagrams immediately
            if (visibleMermaids.length > 0) {
                for (const el of visibleMermaids) {
                    const code = el.getAttribute('data-mermaid-code');
                    const hash = el.getAttribute('data-hash');
                    if (code) {
                        el.textContent = decodeURIComponent(code);
                        el.classList.remove('mermaid-lazy', 'mermaid-placeholder');
                        el.classList.add('mermaid');
                    }
                }
                try {
                    await mermaid.run({
                        nodes: visibleMermaids
                    });
                    // Cache rendered SVGs
                    visibleMermaids.forEach(el => {
                        const hash = el.getAttribute('data-hash');
                        if (hash && el.innerHTML.includes('<svg')) {
                            mermaidCache.set(hash, el.innerHTML);
                        }
                    });
                } catch (error) {
                    console.error('Mermaid rendering error:', error);
                }
            }

            // Observe offscreen mermaid diagrams for lazy loading
            offscreenMermaids.forEach(el => {
                lazyRenderObserver.observe(el);
            });

            // Process math equations - render visible ones immediately, lazy-load others
            const lazyMath = preview.querySelectorAll('.math-lazy');

            lazyMath.forEach(el => {
                if (isInViewport(el)) {
                    // Render immediately
                    const mathSrc = decodeURIComponent(el.getAttribute('data-math-src') || '');
                    const hash = el.getAttribute('data-math-hash');
                    const isBlock = el.classList.contains('math-content');

                    if (mathSrc) {
                        try {
                            const rendered = katex.renderToString(mathSrc, {
                                displayMode: isBlock,
                                throwOnError: false,
                                errorColor: '#cc0000'
                            });
                            el.innerHTML = rendered;
                            el.classList.remove('math-lazy', 'math-placeholder');
                            el.classList.add('math-cached');

                            if (hash) {
                                mathCache.set(hash, rendered);
                            }
                        } catch (error) {
                            console.error('KaTeX rendering error:', error);
                        }
                    }
                } else {
                    // Observe for lazy loading
                    lazyRenderObserver.observe(el);
                }
            });

            // Restore scroll position
            if (wasAtBottom) {
                // If user was at the bottom, stay at the bottom
                preview.scrollTop = preview.scrollHeight;
            } else {
                // Otherwise restore the previous position
                preview.scrollTop = scrollTop;
            }

            // Update counts
            mermaidCount.textContent = mermaidBlocks.length;
            document.getElementById('math-count').textContent = mathCounter;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update statistics
        function updateStats() {
            const text = editor.value;
            charCount.textContent = text.length;
            lineCount.textContent = `${text.split('\n').length} 行`;
        }

        // Resizer functionality
        function initResizer() {
            let isResizing = false;
            
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizer.classList.add('active');
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const containerRect = document.querySelector('.main-container').getBoundingClientRect();
                const newWidth = e.clientX - containerRect.left;
                const percentage = (newWidth / containerRect.width) * 100;
                
                if (percentage >= 15 && percentage <= 85) {
                    editorPanel.style.width = `${percentage}%`;
                }
            });
            
            document.addEventListener('mouseup', () => {
                isResizing = false;
                resizer.classList.remove('active');
            });
        }

        // Theme toggle
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? '' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeIcon();
            updateMermaidTheme();
            updateCodeMirrorTheme();
        }

        function updateThemeIcon() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.getElementById('theme-icon-light').style.display = isDark ? 'none' : 'block';
            document.getElementById('theme-icon-dark').style.display = isDark ? 'block' : 'none';

            // Update highlight.js theme
            const hljsTheme = document.getElementById('hljs-theme');
            hljsTheme.href = isDark
                ? 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css'
                : 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css';
        }

        function updateCodeMirrorTheme() {
            if (cmEditor) {
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                cmEditor.setOption('theme', isDark ? 'material-darker' : 'default');
            }
        }

        // Color theme
        function toggleColorPalette() {
            const palette = document.getElementById('color-palette');
            palette.classList.toggle('open');
        }

        function setColorTheme(color, save = true) {
            document.body.setAttribute('data-color', color);
            
            // Update active swatch
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.toggle('active', swatch.dataset.color === color);
            });
            
            if (save) {
                localStorage.setItem('colorTheme', color);
                showToast(t('colorThemeChanged'));
            }
            
            // Close palette
            document.getElementById('color-palette').classList.remove('open');
        }

        function getColorName(color) {
            const names = {
                indigo: 'インディゴ',
                blue: 'ブルー',
                emerald: 'エメラルド',
                rose: 'ローズ',
                amber: 'アンバー',
                cyan: 'シアン',
                violet: 'バイオレット',
                slate: 'スレート'
            };
            return names[color] || color;
        }

        function updateMermaidTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            mermaid.initialize({
                startOnLoad: false,
                theme: isDark ? 'dark' : 'default',
                securityLevel: 'loose'
            });
            // Clear mermaid cache when theme changes (SVGs have different colors)
            mermaidCache.clear();
            updatePreview();
        }

        // Dropdown toggle
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const wasOpen = dropdown.classList.contains('open');
            
            // Close all dropdowns
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            
            if (!wasOpen) {
                dropdown.classList.add('open');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            }
            if (!e.target.closest('.color-palette-btn') && !e.target.closest('.color-palette-popup')) {
                document.getElementById('color-palette').classList.remove('open');
            }
            if (!e.target.closest('.indent-btn') && !e.target.closest('.indent-popup')) {
                document.getElementById('indent-popup').classList.remove('open');
            }
            if (!e.target.closest('.font-btn') && !e.target.closest('.font-popup')) {
                document.getElementById('font-popup').classList.remove('open');
            }
        });

        // Font settings
        let editorFontSize = parseInt(localStorage.getItem('editorFontSize')) || 14;
        let editorFontFamily = localStorage.getItem('editorFontFamily') || "'JetBrains Mono', monospace";
        let previewFontSize = parseInt(localStorage.getItem('previewFontSize')) || 16;
        let previewFontFamily = localStorage.getItem('previewFontFamily') || "'Noto Sans JP', 'Noto Sans SC', sans-serif";

        function toggleFontPopup() {
            document.getElementById('font-popup').classList.toggle('open');
        }

        function setEditorFontFamily(family) {
            editorFontFamily = family;
            localStorage.setItem('editorFontFamily', family);
            if (cmEditor) {
                cmEditor.getWrapperElement().style.fontFamily = family;
            } else {
                editorTextarea.style.fontFamily = family;
            }
        }

        function adjustEditorFontSize(delta) {
            editorFontSize = Math.max(10, Math.min(24, editorFontSize + delta));
            localStorage.setItem('editorFontSize', editorFontSize);
            if (cmEditor) {
                cmEditor.getWrapperElement().style.fontSize = editorFontSize + 'px';
                cmEditor.refresh();
            } else {
                editorTextarea.style.fontSize = editorFontSize + 'px';
            }
            document.getElementById('editor-font-size-display').textContent = editorFontSize + 'px';
        }

        function setPreviewFontFamily(family) {
            previewFontFamily = family;
            localStorage.setItem('previewFontFamily', family);
            preview.style.fontFamily = family;
        }

        function adjustPreviewFontSize(delta) {
            previewFontSize = Math.max(12, Math.min(28, previewFontSize + delta));
            localStorage.setItem('previewFontSize', previewFontSize);
            preview.style.fontSize = previewFontSize + 'px';
            document.getElementById('preview-font-size-display').textContent = previewFontSize + 'px';
        }

        function initFontSettings() {
            // Apply saved settings to CodeMirror or textarea
            if (cmEditor) {
                cmEditor.getWrapperElement().style.fontFamily = editorFontFamily;
                cmEditor.getWrapperElement().style.fontSize = editorFontSize + 'px';
            } else {
                editorTextarea.style.fontFamily = editorFontFamily;
                editorTextarea.style.fontSize = editorFontSize + 'px';
            }
            preview.style.fontFamily = previewFontFamily;
            preview.style.fontSize = previewFontSize + 'px';

            // Update UI
            document.getElementById('editor-font-size-display').textContent = editorFontSize + 'px';
            document.getElementById('preview-font-size-display').textContent = previewFontSize + 'px';

            // Set select values
            const editorFontSelect = document.getElementById('editor-font-family');
            const previewFontSelect = document.getElementById('preview-font-family');

            // Find and select matching option
            for (let option of editorFontSelect.options) {
                if (option.value === editorFontFamily) {
                    option.selected = true;
                    break;
                }
            }
            for (let option of previewFontSelect.options) {
                if (option.value === previewFontFamily) {
                    option.selected = true;
                    break;
                }
            }
        }

        // Indent size setting
        let indentSize = parseInt(localStorage.getItem('indentSize')) || 2;

        function toggleIndentPopup() {
            document.getElementById('indent-popup').classList.toggle('open');
        }

        function setIndentSize(size) {
            indentSize = size;
            localStorage.setItem('indentSize', size);
            document.getElementById('current-indent-size').textContent = size;

            // Update CodeMirror indent settings
            if (cmEditor) {
                cmEditor.setOption('indentUnit', size);
                cmEditor.setOption('tabSize', size);
            }

            // Update active state
            document.querySelectorAll('.indent-option').forEach(opt => {
                opt.classList.toggle('active', parseInt(opt.dataset.size) === size);
            });

            document.getElementById('indent-popup').classList.remove('open');
        }

        function initIndentSize() {
            document.getElementById('current-indent-size').textContent = indentSize;
            document.querySelectorAll('.indent-option').forEach(opt => {
                opt.classList.toggle('active', parseInt(opt.dataset.size) === indentSize);
            });
        }

        // File operations
        function newFile() {
            if (isDirty && !confirm(t('unsavedChanges'))) {
                return;
            }
            editor.value = '';
            currentFileName = 'untitled.md';
            fileHandle = null;
            isDirty = false;
            updateFileNameDisplay();
            updatePreview();
            updateStats();
            showToast(t('newFileCreated'));
        }

        function openFile() {
            fileInput.click();
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                editor.value = text;
                currentFileName = file.name;
                isDirty = false;
                updateFileNameDisplay();
                updatePreview();
                updateStats();
                showToast(t('fileOpened') + file.name);
            } catch (error) {
                showToast(t('fileReadFailed'));
                console.error(error);
            }
            
            fileInput.value = '';
        });

        async function saveFile() {
            if ('showSaveFilePicker' in window && fileHandle) {
                try {
                    const writable = await fileHandle.createWritable();
                    await writable.write(editor.value);
                    await writable.close();
                    isDirty = false;
                    showToast(t('fileSaved'));
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        saveFileAs();
                    }
                }
            } else {
                saveFileAs();
            }
        }

        async function saveFileAs() {
            if ('showSaveFilePicker' in window) {
                try {
                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: currentFileName,
                        types: [{
                            description: 'Markdown Files',
                            accept: { 'text/markdown': ['.md'] }
                        }, {
                            description: 'Text Files',
                            accept: { 'text/plain': ['.txt'] }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(editor.value);
                    await writable.close();
                    
                    currentFileName = fileHandle.name;
                    isDirty = false;
                    updateFileNameDisplay();
                    showToast(t('fileSavedAs') + currentFileName);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        downloadFile();
                    }
                }
            } else {
                downloadFile();
            }
        }

        function downloadFile() {
            const blob = new Blob([editor.value], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName;
            a.click();
            URL.revokeObjectURL(url);
            isDirty = false;
            showToast(t('fileDownloaded') + currentFileName);
        }

        function updateFileNameDisplay() {
            fileNameDisplay.textContent = currentFileName;
        }

        // Print
        function printPreview() {
            // Render all lazy math equations before printing
            const lazyMathElements = preview.querySelectorAll('.math-lazy');
            lazyMathElements.forEach(el => {
                renderLazyMath(el);
            });

            // Render all lazy mermaid diagrams before printing
            const lazyMermaidElements = preview.querySelectorAll('.mermaid-lazy');
            const mermaidPromises = Array.from(lazyMermaidElements).map(el => {
                return new Promise(resolve => {
                    renderLazyMermaid(el);
                    resolve();
                });
            });

            // Wait a moment for rendering to complete, then print
            Promise.all(mermaidPromises).then(() => {
                setTimeout(() => {
                    window.print();
                }, 100);
            });
        }

        // Mermaid export functions
        async function downloadMermaidPNG(id) {
            const container = document.querySelector(`[data-mermaid-id="${id}"]`);
            if (!container) {
                showToast(t('diagramNotFound'));
                return;
            }
            
            try {
                // Hide action buttons temporarily
                const actions = container.querySelector('.mermaid-actions');
                if (actions) actions.style.display = 'none';
                
                const canvas = await html2canvas(container, {
                    backgroundColor: document.body.getAttribute('data-theme') === 'dark' ? '#1a1a2e' : '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                // Restore action buttons
                if (actions) actions.style.display = '';
                
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mermaid-diagram-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast(t('pngDownloaded'));
                }, 'image/png');
            } catch (error) {
                console.error('PNG export error:', error);
                showToast(t('pngExportFailed'));
            }
        }

        function downloadMermaidSVG(id) {
            const element = document.getElementById(id);
            if (!element) return;

            try {
                const svg = element.querySelector('svg');
                if (!svg) {
                    showToast(t('svgNotFound'));
                    return;
                }

                const svgData = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `mermaid-diagram-${Date.now()}.svg`;
                a.click();

                URL.revokeObjectURL(url);
                showToast(t('svgDownloaded'));
            } catch (error) {
                console.error('SVG export error:', error);
                showToast(t('svgNotFound'));
            }
        }

        // Math export functions
        async function downloadMathPNG(id) {
            const container = document.querySelector(`[data-math-id="${id}"]`);
            if (!container) {
                showToast(t('equationNotFound'));
                return;
            }

            try {
                // Hide action buttons temporarily
                const actions = container.querySelector('.math-actions');
                if (actions) actions.style.display = 'none';

                const canvas = await html2canvas(container, {
                    backgroundColor: document.body.getAttribute('data-theme') === 'dark' ? '#1a1a2e' : '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });

                // Restore action buttons
                if (actions) actions.style.display = '';

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `math-equation-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast(t('pngDownloaded'));
                }, 'image/png');
            } catch (error) {
                console.error('Math PNG export error:', error);
                showToast(t('pngExportFailed'));
            }
        }

        function downloadMathSVG(id) {
            const element = document.getElementById(id);
            if (!element) {
                showToast(t('equationNotFound'));
                return;
            }

            try {
                const katexElement = element.querySelector('.katex');
                if (!katexElement) {
                    showToast(t('equationNotFound'));
                    return;
                }

                // Create SVG from KaTeX rendered content
                const svgNS = "http://www.w3.org/2000/svg";
                const svg = document.createElementNS(svgNS, "svg");

                // Get bounding box - use scrollWidth/scrollHeight for full content size
                // Also check all child elements to get the true bounding box
                const bbox = katexElement.getBoundingClientRect();
                const katexHtml = katexElement.querySelector('.katex-html');

                // Calculate actual width including all positioned elements
                let actualWidth = bbox.width;
                let actualHeight = bbox.height;

                if (katexHtml) {
                    // Get all child elements and find the maximum extent
                    const children = katexHtml.querySelectorAll('*');
                    children.forEach(child => {
                        const childRect = child.getBoundingClientRect();
                        const rightEdge = childRect.right - bbox.left;
                        const bottomEdge = childRect.bottom - bbox.top;
                        if (rightEdge > actualWidth) actualWidth = rightEdge;
                        if (bottomEdge > actualHeight) actualHeight = bottomEdge;
                    });
                }

                // Add extra buffer for any overflow
                actualWidth = Math.max(actualWidth, katexElement.scrollWidth) + 10;
                actualHeight = Math.max(actualHeight, katexElement.scrollHeight) + 10;

                const padding = 20;

                svg.setAttribute("xmlns", svgNS);
                svg.setAttribute("width", actualWidth + padding * 2);
                svg.setAttribute("height", actualHeight + padding * 2);
                svg.setAttribute("viewBox", `0 0 ${actualWidth + padding * 2} ${actualHeight + padding * 2}`);

                // Create foreignObject to embed HTML
                const foreignObject = document.createElementNS(svgNS, "foreignObject");
                foreignObject.setAttribute("x", padding);
                foreignObject.setAttribute("y", padding);
                foreignObject.setAttribute("width", actualWidth);
                foreignObject.setAttribute("height", actualHeight);

                // Clone the KaTeX element and include necessary styles
                const clonedKatex = katexElement.cloneNode(true);
                clonedKatex.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");

                // Add inline styles for standalone SVG
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                const bgColor = isDark ? '#1a1a2e' : '#ffffff';
                const textColor = isDark ? '#e8e8f0' : '#1a1a2e';

                // Add background rect
                const bgRect = document.createElementNS(svgNS, "rect");
                bgRect.setAttribute("width", "100%");
                bgRect.setAttribute("height", "100%");
                bgRect.setAttribute("fill", bgColor);
                svg.appendChild(bgRect);

                foreignObject.appendChild(clonedKatex);
                svg.appendChild(foreignObject);

                // Add KaTeX CSS link
                const style = document.createElementNS(svgNS, "style");
                style.textContent = `
                    @import url('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css');
                    .katex { color: ${textColor}; font-size: 1.2em; }
                `;
                svg.insertBefore(style, svg.firstChild);

                const svgData = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `math-equation-${Date.now()}.svg`;
                a.click();

                URL.revokeObjectURL(url);
                showToast(t('svgDownloaded'));
            } catch (error) {
                console.error('Math SVG export error:', error);
                showToast(t('svgNotFound'));
            }
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==================== Sample Code Modal ====================
        const mermaidSamples = [
            {
                name: { en: 'Flowchart', ja: 'フローチャート', zh: '流程图' },
                code: `\`\`\`mermaid
flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Process A]
    B -->|No| D[Process B]
    C --> E[End]
    D --> E
\`\`\``
            },
            {
                name: { en: 'Sequence Diagram', ja: 'シーケンス図', zh: '时序图' },
                code: `\`\`\`mermaid
sequenceDiagram
    participant A as Alice
    participant B as Bob
    A->>B: Hello Bob!
    B-->>A: Hi Alice!
    A->>B: How are you?
    B-->>A: I'm fine, thanks!
\`\`\``
            },
            {
                name: { en: 'Class Diagram', ja: 'クラス図', zh: '类图' },
                code: `\`\`\`mermaid
classDiagram
    Animal <|-- Duck
    Animal <|-- Fish
    Animal : +int age
    Animal : +String gender
    Animal: +isMammal()
    Duck : +String beakColor
    Duck : +swim()
    Fish : -int sizeInFeet
    Fish : +canEat()
\`\`\``
            },
            {
                name: { en: 'State Diagram', ja: '状態図', zh: '状态图' },
                code: `\`\`\`mermaid
stateDiagram-v2
    [*] --> Idle
    Idle --> Processing : Start
    Processing --> Complete : Success
    Processing --> Error : Failure
    Complete --> [*]
    Error --> Idle : Retry
\`\`\``
            },
            {
                name: { en: 'Entity Relationship', ja: 'ER図', zh: 'ER图' },
                code: `\`\`\`mermaid
erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ LINE-ITEM : contains
    CUSTOMER {
        string name
        string email
    }
    ORDER {
        int orderNumber
        date created
    }
    LINE-ITEM {
        string product
        int quantity
    }
\`\`\``
            },
            {
                name: { en: 'Gantt Chart', ja: 'ガントチャート', zh: '甘特图' },
                code: `\`\`\`mermaid
gantt
    title Project Schedule
    dateFormat YYYY-MM-DD
    section Planning
    Requirements :a1, 2024-01-01, 7d
    Design       :a2, after a1, 5d
    section Development
    Coding       :a3, after a2, 14d
    Testing      :a4, after a3, 7d
\`\`\``
            },
            {
                name: { en: 'Pie Chart', ja: '円グラフ', zh: '饼图' },
                code: `\`\`\`mermaid
pie title Browser Market Share
    "Chrome" : 65
    "Safari" : 19
    "Firefox" : 4
    "Edge" : 4
    "Other" : 8
\`\`\``
            },
            {
                name: { en: 'Git Graph', ja: 'Gitグラフ', zh: 'Git图' },
                code: `\`\`\`mermaid
gitGraph
    commit
    commit
    branch develop
    checkout develop
    commit
    commit
    checkout main
    merge develop
    commit
\`\`\``
            },
            {
                name: { en: 'Mindmap', ja: 'マインドマップ', zh: '思维导图' },
                code: `\`\`\`mermaid
mindmap
  root((Project))
    Planning
      Requirements
      Design
    Development
      Frontend
      Backend
    Testing
      Unit Tests
      Integration
\`\`\``
            },
            {
                name: { en: 'Timeline', ja: 'タイムライン', zh: '时间线' },
                code: `\`\`\`mermaid
timeline
    title Project History
    2020 : Project Started
    2021 : Version 1.0 Released
    2022 : Major Update
         : New Features Added
    2023 : Version 2.0 Released
\`\`\``
            }
        ];

        const mathSamples = [
            {
                name: { en: 'Superscript', ja: '上付き文字', zh: '上标' },
                code: `$$x^2 + y^2 = z^2$$`
            },
            {
                name: { en: 'Subscript', ja: '下付き文字', zh: '下标' },
                code: `$$a_1, a_2, a_3, \\ldots, a_n$$`
            },
            {
                name: { en: 'Fraction', ja: '分数', zh: '分数' },
                code: `$$\\frac{a}{b} + \\frac{c}{d} = \\frac{ad + bc}{bd}$$`
            },
            {
                name: { en: 'Quadratic Formula', ja: '二次方程式の解', zh: '二次方程求根公式' },
                code: `$$x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$$`
            },
            {
                name: { en: 'Integral', ja: '積分', zh: '积分' },
                code: `$$\\int_{a}^{b} f(x) \\, dx = F(b) - F(a)$$`
            },
            {
                name: { en: 'Derivative', ja: '微分', zh: '微分' },
                code: `$$\\frac{d}{dx} f(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$`
            },
            {
                name: { en: 'Summation', ja: '総和記号', zh: '求和符号' },
                code: `$$\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}$$`
            },
            {
                name: { en: 'Product', ja: '総乗記号', zh: '连乘符号' },
                code: `$$\\prod_{i=1}^{n} i = n!$$`
            },
            {
                name: { en: 'Matrix', ja: '行列', zh: '矩阵' },
                code: `$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax + by \\\\ cx + dy \\end{pmatrix}$$`
            },
            {
                name: { en: 'Determinant', ja: '行列式', zh: '行列式' },
                code: `$$\\det(A) = \\begin{vmatrix} a & b \\\\ c & d \\end{vmatrix} = ad - bc$$`
            },
            {
                name: { en: 'System of Equations', ja: '連立方程式', zh: '方程组' },
                code: `$$\\begin{cases} ax + by = e \\\\ cx + dy = f \\end{cases}$$`
            },
            {
                name: { en: 'Limit', ja: '極限', zh: '极限' },
                code: `$$\\lim_{x \\to \\infty} \\left(1 + \\frac{1}{x}\\right)^x = e$$`
            }
        ];

        function openSampleModal() {
            const modal = document.getElementById('sample-modal');
            modal.classList.add('open');
            renderSampleCards();
        }

        function closeSampleModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('sample-modal').classList.remove('open');
        }

        function switchSampleTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tab}`);
            });
        }

        function renderSampleCards() {
            renderMermaidSamples();
            renderMathSamples();
        }

        async function renderMermaidSamples() {
            const container = document.getElementById('mermaid-samples');
            container.innerHTML = '';

            for (let i = 0; i < mermaidSamples.length; i++) {
                const sample = mermaidSamples[i];
                const card = document.createElement('div');
                card.className = 'sample-card';
                card.onclick = () => insertSample(sample.code);

                const title = document.createElement('div');
                title.className = 'sample-card-title';
                title.textContent = sample.name[currentLang] || sample.name.en;

                const preview = document.createElement('div');
                preview.className = 'sample-card-preview';

                // Extract mermaid code from the markdown code block
                const mermaidCode = sample.code.replace(/```mermaid\n?/, '').replace(/\n?```$/, '');
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                preview.appendChild(mermaidDiv);

                card.appendChild(title);
                card.appendChild(preview);
                container.appendChild(card);
            }

            // Re-render mermaid diagrams
            try {
                await mermaid.run({ nodes: container.querySelectorAll('.mermaid') });
            } catch (e) {
                console.log('Mermaid render error in modal:', e);
            }
        }

        function renderMathSamples() {
            const container = document.getElementById('math-samples');
            container.innerHTML = '';

            mathSamples.forEach(sample => {
                const card = document.createElement('div');
                card.className = 'sample-card';
                card.onclick = () => insertSample(sample.code);

                const title = document.createElement('div');
                title.className = 'sample-card-title';
                title.textContent = sample.name[currentLang] || sample.name.en;

                const preview = document.createElement('div');
                preview.className = 'sample-card-preview';

                // Render KaTeX
                const mathCode = sample.code.replace(/^\$\$/, '').replace(/\$\$$/, '');
                try {
                    preview.innerHTML = katex.renderToString(mathCode, {
                        throwOnError: false,
                        displayMode: true
                    });
                } catch (e) {
                    preview.textContent = sample.code;
                }

                card.appendChild(title);
                card.appendChild(preview);
                container.appendChild(card);
            });
        }

        function insertSample(code) {
            // Save state before change for undo
            saveState();

            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const value = editor.value;

            // Add newlines if not at beginning or if there's content before
            let insertion = code;
            if (start > 0 && value[start - 1] !== '\n') {
                insertion = '\n\n' + insertion;
            }
            if (end < value.length && value[end] !== '\n') {
                insertion = insertion + '\n\n';
            }

            editor.value = value.substring(0, start) + insertion + value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + insertion.length;

            // Save state after change for undo
            saveState();

            isDirty = true;
            schedulePreviewUpdate();
            updateStats();
            closeSampleModal();
            showToast(t('sampleInserted'));
            editor.focus();
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (isDirty) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    
    </script>

    <!-- Sample Code Modal -->
    <div class="modal-overlay" id="sample-modal" onclick="closeSampleModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" data-i18n="sampleCode">Sample Code</span>
                <button class="modal-close" onclick="closeSampleModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="mermaid" onclick="switchSampleTab('mermaid')">
                    <span data-i18n="mermaidDiagrams">Mermaid Diagrams</span>
                </button>
                <button class="modal-tab" data-tab="math" onclick="switchSampleTab('math')">
                    <span data-i18n="mathFormulas">Math Formulas</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="tab-content active" id="tab-mermaid">
                    <div class="sample-grid" id="mermaid-samples"></div>
                </div>
                <div class="tab-content" id="tab-math">
                    <div class="sample-grid" id="math-samples"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>