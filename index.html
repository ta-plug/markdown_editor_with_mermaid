<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor Pro</title>
    
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" id="hljs-theme">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- html2canvas for PNG export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Theme */
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f0f0;
            --text-primary: #1a1a2e;
            --text-secondary: #4a4a5a;
            --text-muted: #8a8a9a;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.08);
            --divider: #d0d0d0;
            --success: #10b981;
            --warning: #f59e0b;
            --toolbar-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --editor-bg: #ffffff;
            --preview-bg: #fefefe;
            --code-bg: #f6f8fa;
            --scrollbar-track: #f0f0f0;
            --scrollbar-thumb: #c0c0c0;
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252540;
            --text-primary: #e8e8f0;
            --text-secondary: #b0b0c0;
            --text-muted: #6a6a7a;
            --accent: #818cf8;
            --accent-hover: #a5b4fc;
            --accent-light: rgba(129, 140, 248, 0.15);
            --border: #2a2a40;
            --shadow: rgba(0, 0, 0, 0.3);
            --divider: #3a3a50;
            --toolbar-bg: linear-gradient(135deg, #1e1e3f 0%, #2d1b4e 100%);
            --editor-bg: #12121f;
            --preview-bg: #16162a;
            --code-bg: #1e1e2e;
            --scrollbar-track: #1a1a2e;
            --scrollbar-thumb: #3a3a50;
        }

        /* Color Themes */
        [data-color="indigo"] {
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --toolbar-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        [data-theme="dark"][data-color="indigo"] {
            --accent: #818cf8;
            --accent-hover: #a5b4fc;
            --accent-light: rgba(129, 140, 248, 0.15);
            --toolbar-bg: linear-gradient(135deg, #1e1e3f 0%, #2d1b4e 100%);
        }

        [data-color="blue"] {
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-light: rgba(59, 130, 246, 0.1);
            --toolbar-bg: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        [data-theme="dark"][data-color="blue"] {
            --accent: #60a5fa;
            --accent-hover: #93c5fd;
            --accent-light: rgba(96, 165, 250, 0.15);
            --toolbar-bg: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
        }

        [data-color="emerald"] {
            --accent: #10b981;
            --accent-hover: #059669;
            --accent-light: rgba(16, 185, 129, 0.1);
            --toolbar-bg: linear-gradient(135deg, #10b981 0%, #047857 100%);
        }
        [data-theme="dark"][data-color="emerald"] {
            --accent: #34d399;
            --accent-hover: #6ee7b7;
            --accent-light: rgba(52, 211, 153, 0.15);
            --toolbar-bg: linear-gradient(135deg, #064e3b 0%, #047857 100%);
        }

        [data-color="rose"] {
            --accent: #f43f5e;
            --accent-hover: #e11d48;
            --accent-light: rgba(244, 63, 94, 0.1);
            --toolbar-bg: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
        }
        [data-theme="dark"][data-color="rose"] {
            --accent: #fb7185;
            --accent-hover: #fda4af;
            --accent-light: rgba(251, 113, 133, 0.15);
            --toolbar-bg: linear-gradient(135deg, #4c0519 0%, #9f1239 100%);
        }

        [data-color="amber"] {
            --accent: #f59e0b;
            --accent-hover: #d97706;
            --accent-light: rgba(245, 158, 11, 0.1);
            --toolbar-bg: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
        }
        [data-theme="dark"][data-color="amber"] {
            --accent: #fbbf24;
            --accent-hover: #fcd34d;
            --accent-light: rgba(251, 191, 36, 0.15);
            --toolbar-bg: linear-gradient(135deg, #451a03 0%, #92400e 100%);
        }

        [data-color="cyan"] {
            --accent: #06b6d4;
            --accent-hover: #0891b2;
            --accent-light: rgba(6, 182, 212, 0.1);
            --toolbar-bg: linear-gradient(135deg, #06b6d4 0%, #0e7490 100%);
        }
        [data-theme="dark"][data-color="cyan"] {
            --accent: #22d3ee;
            --accent-hover: #67e8f9;
            --accent-light: rgba(34, 211, 238, 0.15);
            --toolbar-bg: linear-gradient(135deg, #083344 0%, #0e7490 100%);
        }

        [data-color="violet"] {
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --accent-light: rgba(139, 92, 246, 0.1);
            --toolbar-bg: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        }
        [data-theme="dark"][data-color="violet"] {
            --accent: #a78bfa;
            --accent-hover: #c4b5fd;
            --accent-light: rgba(167, 139, 250, 0.15);
            --toolbar-bg: linear-gradient(135deg, #2e1065 0%, #5b21b6 100%);
        }

        [data-color="slate"] {
            --accent: #64748b;
            --accent-hover: #475569;
            --accent-light: rgba(100, 116, 139, 0.1);
            --toolbar-bg: linear-gradient(135deg, #64748b 0%, #334155 100%);
        }
        [data-theme="dark"][data-color="slate"] {
            --accent: #94a3b8;
            --accent-hover: #cbd5e1;
            --accent-light: rgba(148, 163, 184, 0.15);
            --toolbar-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 5px;
            transition: background 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Toolbar */
        .toolbar {
            background: var(--toolbar-bg);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            z-index: 100;
        }

        .toolbar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-title svg {
            width: 28px;
            height: 28px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toolbar-group:first-of-type {
            border-left: none;
            padding-left: 0;
        }

        .toolbar-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0);
        }

        .toolbar-btn svg {
            width: 16px;
            height: 16px;
        }

        .file-name {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'JetBrains Mono', monospace;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .spacer {
            flex: 1;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(15deg);
        }

        .theme-toggle svg {
            width: 22px;
            height: 22px;
            color: white;
        }

        /* Main Container */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Editor Panel */
        .editor-panel {
            width: 50%;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            background: var(--editor-bg);
            border-right: 1px solid var(--border);
        }

        .panel-header {
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--accent);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-header svg {
            width: 16px;
            height: 16px;
            color: var(--accent);
            opacity: 1;
        }

        #editor {
            flex: 1;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.7;
            background: var(--editor-bg);
            color: var(--text-primary);
            border: none;
            outline: none;
            resize: none;
            tab-size: 4;
            caret-color: var(--accent);
        }

        #editor::placeholder {
            color: var(--text-muted);
        }

        #editor::selection {
            background: var(--accent-light);
            color: var(--text-primary);
        }

        /* Resizer */
        .resizer {
            width: 6px;
            background: var(--divider);
            cursor: col-resize;
            transition: background 0.2s ease;
            position: relative;
        }

        .resizer:hover,
        .resizer.active {
            background: var(--accent);
        }

        .resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 40px;
            background: var(--text-muted);
            border-radius: 1px;
            opacity: 0.5;
        }

        /* Preview Panel */
        .preview-panel {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            background: var(--preview-bg);
            overflow: hidden;
        }

        #preview {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
            line-height: 1.8;
        }

        /* Markdown Styles */
        #preview h1 {
            font-size: 2em;
            font-weight: 700;
            margin: 1.5em 0 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 3px solid var(--accent);
            color: var(--text-primary);
        }

        #preview h1:first-child {
            margin-top: 0;
        }

        #preview h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 1.3em 0 0.4em;
            color: var(--text-primary);
            padding-left: 12px;
            border-left: 4px solid var(--accent);
        }

        #preview h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 1.2em 0 0.4em;
            color: var(--accent);
        }

        #preview h4, #preview h5, #preview h6 {
            font-size: 1em;
            font-weight: 600;
            margin: 1em 0 0.4em;
            color: var(--text-secondary);
        }

        #preview p {
            margin: 0.8em 0;
            color: var(--text-primary);
        }

        #preview strong {
            color: var(--accent);
            font-weight: 600;
        }

        #preview a {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px solid var(--accent-light);
            transition: border-color 0.2s ease;
        }

        #preview a:hover {
            border-bottom-color: var(--accent);
        }

        #preview ul, #preview ol {
            margin: 0.8em 0;
            padding-left: 2em;
        }

        #preview li {
            margin: 0.3em 0;
        }

        #preview li::marker {
            color: var(--accent);
        }

        #preview blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            border-left: 4px solid var(--accent);
            background: var(--accent-light);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
        }

        #preview code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            background: var(--accent-light);
            padding: 0.2em 0.5em;
            border-radius: 4px;
            color: var(--accent);
        }

        #preview pre {
            margin: 1em 0;
            padding: 16px;
            background: var(--code-bg);
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
        }

        #preview pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }

        #preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        #preview th, #preview td {
            padding: 10px 14px;
            border: 1px solid var(--border);
            text-align: left;
        }

        #preview th {
            background: var(--accent-light);
            font-weight: 600;
            color: var(--accent);
        }

        #preview tr:nth-child(even) {
            background: var(--bg-tertiary);
        }

        #preview ::selection {
            background: var(--accent-light);
            color: var(--text-primary);
        }

        #preview img {
            max-width: 100%;
            border-radius: 8px;
            margin: 1em 0;
        }

        #preview hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), var(--accent-light), transparent);
            margin: 2em 0;
        }

        /* Mermaid Container */
        .mermaid-container {
            position: relative;
            margin: 1.5em 0;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            overflow: visible;
        }

        .mermaid-container .mermaid {
            display: flex;
            justify-content: center;
        }

        .mermaid-container svg {
            max-width: 100%;
            height: auto;
        }

        .mermaid-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .mermaid-container:hover .mermaid-actions {
            opacity: 1;
        }

        .mermaid-action-btn {
            background: var(--accent);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .mermaid-action-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .mermaid-action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Lazy loading placeholders */
        .mermaid-placeholder,
        .math-placeholder {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .lazy-placeholder-text {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9em;
            opacity: 0.7;
        }

        .mermaid-placeholder .lazy-placeholder-text {
            font-family: monospace;
        }

        /* Status Bar */
        .status-bar {
            padding: 8px 20px;
            background: var(--bg-tertiary);
            border-top: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-item svg {
            width: 14px;
            height: 14px;
            color: var(--accent);
        }

        /* Hidden file input */
        #file-input {
            display: none;
        }

        /* Print Styles */
        @media print {
            body {
                height: auto !important;
                overflow: visible !important;
                background: white !important;
                color: black !important;
            }

            .toolbar, .editor-panel, .resizer, .status-bar, .mermaid-actions, .panel-header {
                display: none !important;
            }

            .main-container {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
            }

            .preview-panel {
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                position: static !important;
            }

            #preview {
                padding: 20px !important;
                overflow: visible !important;
                height: auto !important;
            }

            #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
                color: black !important;
            }

            #preview p, #preview li, #preview td, #preview th {
                color: #333 !important;
            }

            #preview pre, #preview code {
                background: #f5f5f5 !important;
                color: #333 !important;
            }

            #preview pre {
                border: 1px solid #ccc !important;
                white-space: pre-wrap !important;
                word-wrap: break-word !important;
            }

            #preview blockquote {
                border-left-color: #666 !important;
                background: #f9f9f9 !important;
                color: #333 !important;
            }

            #preview table {
                border-collapse: collapse !important;
            }

            #preview th, #preview td {
                border: 1px solid #ccc !important;
            }

            .mermaid-container {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                background: white !important;
                border: 1px solid #ccc !important;
            }

            .mermaid svg {
                max-width: 100% !important;
                height: auto !important;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            right: 24px;
            background: var(--accent);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 20px var(--shadow);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Dropdown menu */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 30px var(--shadow);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
        }

        .dropdown.open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-item:first-child {
            border-radius: 7px 7px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 7px 7px;
        }

        .dropdown-item:hover {
            background: var(--accent-light);
            color: var(--accent);
        }

        .dropdown-item:hover svg {
            color: var(--accent);
        }

        .dropdown-item svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
            transition: color 0.2s ease;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* Color Palette */
        .color-palette-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-palette-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .color-palette-btn svg {
            width: 22px;
            height: 22px;
            color: white;
        }

        .color-palette-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow);
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
            min-width: 200px;
        }

        .color-palette-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .color-palette-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .color-swatch {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.active {
            border-color: var(--text-primary);
        }

        .color-swatch.active::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .color-swatch[data-color="indigo"] { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .color-swatch[data-color="blue"] { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .color-swatch[data-color="emerald"] { background: linear-gradient(135deg, #10b981 0%, #047857 100%); }
        .color-swatch[data-color="rose"] { background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%); }
        .color-swatch[data-color="amber"] { background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%); }
        .color-swatch[data-color="cyan"] { background: linear-gradient(135deg, #06b6d4 0%, #0e7490 100%); }
        .color-swatch[data-color="violet"] { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); }
        .color-swatch[data-color="slate"] { background: linear-gradient(135deg, #64748b 0%, #334155 100%); }

        /* Indent Size Setting */
        .indent-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            height: 44px;
            padding: 0 12px;
            border-radius: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            position: relative;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .indent-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .indent-btn svg {
            width: 18px;
            height: 18px;
        }

        .indent-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
            min-width: 160px;
        }

        .indent-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .indent-popup-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .indent-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .indent-option {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-primary);
        }

        .indent-option:hover {
            background: var(--bg-hover);
        }

        .indent-option.active {
            background: var(--accent);
            color: white;
        }

        .indent-option.active::after {
            content: '‚úì';
            font-weight: bold;
        }

        /* Font Settings */
        .font-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            height: 44px;
            padding: 0 12px;
            border-radius: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            position: relative;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .font-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .font-btn svg {
            width: 18px;
            height: 18px;
        }

        .font-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
            min-width: 280px;
        }

        .font-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .font-popup-section {
            margin-bottom: 16px;
        }

        .font-popup-section:last-child {
            margin-bottom: 0;
        }

        .font-popup-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .font-popup-title svg {
            width: 14px;
            height: 14px;
            stroke: var(--text-muted);
        }

        .font-setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .font-setting-row:last-child {
            margin-bottom: 0;
        }

        .font-setting-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .font-select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            min-width: 130px;
        }

        .font-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-size-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .font-size-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .font-size-value {
            min-width: 50px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .font-divider {
            height: 1px;
            background: var(--border);
            margin: 12px 0;
        }

        /* Sample Code Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
        }

        .modal-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s ease;
        }

        .modal-tab:hover {
            color: var(--text-primary);
        }

        .modal-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .sample-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sample-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .sample-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
        }

        .sample-card-preview {
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .sample-card-preview .mermaid {
            font-size: 10px;
            transform: scale(0.6);
            transform-origin: center;
        }

        .sample-card-preview .katex {
            font-size: 0.9rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Language Popup */
        .lang-popup {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow);
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
            min-width: 180px;
        }

        .lang-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-popup-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .lang-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lang-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .lang-item:hover {
            background: var(--accent-light);
        }

        .lang-item.active {
            background: var(--accent);
            color: white;
        }

        .lang-item-flag {
            font-size: 1.2rem;
        }

        .lang-item-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .lang-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            padding: 0 14px;
            gap: 6px;
        }

        .lang-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Math (KaTeX) Styles */
        .math-container {
            position: relative;
            margin: 1.5em 0;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            overflow: visible;
        }

        .math-container .math-content {
            display: flex;
            justify-content: center;
            overflow-x: auto;
        }

        .math-inline {
            display: inline;
            padding: 0 2px;
        }

        #preview .katex {
            font-size: 1.1em;
        }

        #preview .katex-display {
            margin: 0;
            padding: 0;
        }

        #preview .katex-display > .katex {
            font-size: 1.2em;
        }

        .math-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .math-container:hover .math-actions {
            opacity: 1;
        }

        .math-action-btn {
            background: var(--accent);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .math-action-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .math-action-btn svg {
            width: 14px;
            height: 14px;
        }

        @media print {
            .math-container {
                background: #f5f5f5 !important;
                border-left-color: #666 !important;
            }
            .math-actions {
                display: none !important;
            }
        }

    </style>
</head>
<body>
    <input type="file" id="file-input" accept=".md,.txt,.markdown,text/*">
    
    <div class="toolbar">
        <div class="toolbar-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <line x1="10" y1="9" x2="8" y2="9"/>
            </svg>
            Markdown Editor Pro
        </div>
        
        <div class="toolbar-group">
            <div class="dropdown" id="file-dropdown">
                <button class="toolbar-btn" onclick="toggleDropdown('file-dropdown')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                    </svg>
                    <span data-i18n="file">File</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;">
                        <polyline points="6,9 12,15 18,9"/>
                    </svg>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-item" onclick="newFile()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                            <line x1="12" y1="18" x2="12" y2="12"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        <span data-i18n="newFile">New</span>
                    </div>
                    <div class="dropdown-item" onclick="openFile()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span data-i18n="openFile">Open</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="saveFile()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                        <span data-i18n="save">Save</span>
                    </div>
                    <div class="dropdown-item" onclick="saveFileAs()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                        </svg>
                        <span data-i18n="saveAs">Save As</span>
                    </div>
                </div>
            </div>
            <span class="file-name" id="file-name-display">untitled.md</span>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" id="undo-btn" onclick="performUndo()" data-i18n-title="undo" title="Undo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 10h13a4 4 0 0 1 0 8H9"/>
                    <polyline points="7,6 3,10 7,14"/>
                </svg>
            </button>
            <button class="toolbar-btn" id="redo-btn" onclick="performRedo()" data-i18n-title="redo" title="Redo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10H8a4 4 0 0 0 0 8h7"/>
                    <polyline points="17,6 21,10 17,14"/>
                </svg>
            </button>
            <button class="toolbar-btn" onclick="printPreview()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 6,2 18,2 18,9"/>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                    <rect x="6" y="14" width="12" height="8"/>
                </svg>
                <span data-i18n="print">Print</span>
            </button>
            <button class="toolbar-btn" onclick="openSampleModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="9" y1="9" x2="15" y2="9"/>
                    <line x1="9" y1="13" x2="15" y2="13"/>
                    <line x1="9" y1="17" x2="12" y2="17"/>
                </svg>
                <span data-i18n="samples">Samples</span>
            </button>
        </div>

        <div class="spacer"></div>
        
        <!-- Language Selector -->
        <div style="position: relative;">
            <button class="lang-toggle" onclick="toggleLangPopup()" id="lang-toggle-btn">
                <span id="current-lang-flag">üåê</span>
                <span id="current-lang-code">EN</span>
            </button>
            <div class="lang-popup" id="lang-popup">
                <div class="lang-popup-title" data-i18n="language">Language</div>
                <div class="lang-list">
                    <div class="lang-item active" data-lang="en" onclick="setLanguage('en')">
                        <span class="lang-item-flag">üá∫üá∏</span>
                        <span class="lang-item-name">English</span>
                    </div>
                    <div class="lang-item" data-lang="ja" onclick="setLanguage('ja')">
                        <span class="lang-item-flag">üáØüáµ</span>
                        <span class="lang-item-name">Êó•Êú¨Ë™û</span>
                    </div>
                    <div class="lang-item" data-lang="zh" onclick="setLanguage('zh')">
                        <span class="lang-item-flag">üá®üá≥</span>
                        <span class="lang-item-name">‰∏≠Êñá</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="position: relative;">
            <button class="color-palette-btn" onclick="toggleColorPalette()" data-i18n-title="colorTheme" title="Color Theme">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="4"/>
                    <line x1="12" y1="2" x2="12" y2="4"/>
                    <line x1="12" y1="20" x2="12" y2="22"/>
                    <line x1="2" y1="12" x2="4" y2="12"/>
                    <line x1="20" y1="12" x2="22" y2="12"/>
                </svg>
            </button>
            <div class="color-palette-popup" id="color-palette">
                <div class="color-palette-title" data-i18n="colorTheme">Color Theme</div>
                <div class="color-grid">
                    <div class="color-swatch active" data-color="indigo" onclick="setColorTheme('indigo')" title="Indigo"></div>
                    <div class="color-swatch" data-color="blue" onclick="setColorTheme('blue')" title="Blue"></div>
                    <div class="color-swatch" data-color="cyan" onclick="setColorTheme('cyan')" title="Cyan"></div>
                    <div class="color-swatch" data-color="emerald" onclick="setColorTheme('emerald')" title="Emerald"></div>
                    <div class="color-swatch" data-color="amber" onclick="setColorTheme('amber')" title="Amber"></div>
                    <div class="color-swatch" data-color="rose" onclick="setColorTheme('rose')" title="Rose"></div>
                    <div class="color-swatch" data-color="violet" onclick="setColorTheme('violet')" title="Violet"></div>
                    <div class="color-swatch" data-color="slate" onclick="setColorTheme('slate')" title="Slate"></div>
                </div>
            </div>
        </div>

        <div style="position: relative;">
            <button class="indent-btn" onclick="toggleIndentPopup()" data-i18n-title="indentSize" title="Indent Size">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="21" y1="6" x2="3" y2="6"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                    <line x1="21" y1="18" x2="9" y2="18"/>
                    <polyline points="5 10 3 12 5 14"/>
                </svg>
                <span id="current-indent-size">2</span>
            </button>
            <div class="indent-popup" id="indent-popup">
                <div class="indent-popup-title" data-i18n="indentSize">Indent Size</div>
                <div class="indent-options">
                    <div class="indent-option active" data-size="2" onclick="setIndentSize(2)">2 spaces</div>
                    <div class="indent-option" data-size="4" onclick="setIndentSize(4)">4 spaces</div>
                    <div class="indent-option" data-size="8" onclick="setIndentSize(8)">8 spaces</div>
                </div>
            </div>
        </div>

        <div style="position: relative;">
            <button class="font-btn" onclick="toggleFontPopup()" title="Font Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 7 4 4 20 4 20 7"/>
                    <line x1="9" y1="20" x2="15" y2="20"/>
                    <line x1="12" y1="4" x2="12" y2="20"/>
                </svg>
                <span>Aa</span>
            </button>
            <div class="font-popup" id="font-popup">
                <!-- Editor Font Settings -->
                <div class="font-popup-section">
                    <div class="font-popup-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16,18 22,12 16,6"/>
                            <polyline points="8,6 2,12 8,18"/>
                        </svg>
                        Editor
                    </div>
                    <div class="font-setting-row">
                        <span class="font-setting-label">Font</span>
                        <select class="font-select" id="editor-font-family" onchange="setEditorFontFamily(this.value)">
                            <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                            <option value="'Consolas', monospace">Consolas</option>
                            <option value="'Fira Code', monospace">Fira Code</option>
                            <option value="'Source Code Pro', monospace">Source Code Pro</option>
                            <option value="monospace">System Mono</option>
                        </select>
                    </div>
                    <div class="font-setting-row">
                        <span class="font-setting-label">Size</span>
                        <div class="font-size-control">
                            <button class="font-size-btn" onclick="adjustEditorFontSize(-1)">‚àí</button>
                            <span class="font-size-value" id="editor-font-size-display">14px</span>
                            <button class="font-size-btn" onclick="adjustEditorFontSize(1)">+</button>
                        </div>
                    </div>
                </div>

                <div class="font-divider"></div>

                <!-- Preview Font Settings -->
                <div class="font-popup-section">
                    <div class="font-popup-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        Preview
                    </div>
                    <div class="font-setting-row">
                        <span class="font-setting-label">Font</span>
                        <select class="font-select" id="preview-font-family" onchange="setPreviewFontFamily(this.value)">
                            <option value="'Noto Sans JP', 'Noto Sans SC', sans-serif">Noto Sans</option>
                            <option value="'Segoe UI', sans-serif">Segoe UI</option>
                            <option value="'Helvetica Neue', Arial, sans-serif">Helvetica</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="system-ui, sans-serif">System UI</option>
                        </select>
                    </div>
                    <div class="font-setting-row">
                        <span class="font-setting-label">Size</span>
                        <div class="font-size-control">
                            <button class="font-size-btn" onclick="adjustPreviewFontSize(-1)">‚àí</button>
                            <span class="font-size-value" id="preview-font-size-display">16px</span>
                            <button class="font-size-btn" onclick="adjustPreviewFontSize(1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="theme-toggle" onclick="toggleTheme()" data-i18n-title="darkLightMode" title="Dark/Light Mode">
            <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        </button>
    </div>
    
    <div class="main-container">
        <div class="editor-panel" id="editor-panel">
            <div class="panel-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="16,18 22,12 16,6"/>
                    <polyline points="8,6 2,12 8,18"/>
                </svg>
                <span data-i18n="editor">Editor</span>
            </div>
            <textarea id="editor" data-i18n-placeholder="editorPlaceholder" placeholder="Enter Markdown here..."></textarea>
        </div>
        
        <div class="resizer" id="resizer"></div>
        
        <div class="preview-panel">
            <div class="panel-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <span data-i18n="preview">Preview</span>
            </div>
            <div id="preview"></div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                <polyline points="14,2 14,8 20,8"/>
            </svg>
            <span id="char-count">0</span> <span data-i18n="characters">characters</span>
        </div>
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"/>
                <line x1="8" y1="12" x2="21" y2="12"/>
                <line x1="8" y1="18" x2="21" y2="18"/>
                <line x1="3" y1="6" x2="3.01" y2="6"/>
                <line x1="3" y1="12" x2="3.01" y2="12"/>
                <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            <span id="line-count">0</span> <span data-i18n="lines">lines</span>
        </div>
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
            </svg>
            <span id="mermaid-count">0</span> <span data-i18n="diagrams">diagrams</span>
        </div>
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4z"/>
                <path d="M17 14v3h-3M14 20l6-6"/>
            </svg>
            <span id="math-count">0</span> <span data-i18n="equations">equations</span>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // ==================== Internationalization (i18n) ====================
        const translations = {
            en: {
                file: "File",
                newFile: "New",
                openFile: "Open",
                save: "Save",
                saveAs: "Save As",
                print: "Print",
                samples: "Samples",
                sampleCode: "Sample Code",
                mermaidDiagrams: "Mermaid Diagrams",
                mathFormulas: "Math Formulas",
                sampleInserted: "Sample inserted",
                undo: "Undo",
                redo: "Redo",
                nothingToUndo: "Nothing to undo",
                nothingToRedo: "Nothing to redo",
                editor: "Editor",
                preview: "Preview",
                editorPlaceholder: "Enter Markdown here...",
                characters: "characters",
                lines: "lines",
                diagrams: "diagrams",
                equations: "equations",
                language: "Language",
                colorTheme: "Color Theme",
                indentSize: "Indent Size",
                darkLightMode: "Dark/Light Mode",
                newFileCreated: "New file created",
                fileOpened: "Opened: ",
                fileSaved: "Saved",
                fileSavedAs: "Saved as: ",
                fileDownloaded: "Downloaded: ",
                unsavedChanges: "You have unsaved changes. Create new file anyway?",
                pngDownloaded: "PNG downloaded",
                svgDownloaded: "SVG downloaded",
                pngExportFailed: "Failed to export PNG",
                svgNotFound: "SVG element not found",
                diagramNotFound: "Diagram not found",
                equationNotFound: "Equation not found",
                fileReadFailed: "Failed to read file",
                colorThemeChanged: "Color theme changed",
                sampleMarkdown: `# Welcome to Markdown Editor Pro!

This editor supports **Markdown** and **Mermaid diagrams**.

## Basic Formatting

Text can be **bold** or *italic*. You can also use \`inline code\`.

### Lists

- Item 1
- Item 2
  - Nested item
- Item 3

### Numbered List

1. First step
2. Second step
3. Final step

## Code Block

\`\`\`javascript
function greeting(name) {
    console.log(\`Hello, \${name}!\`);
}

greeting('World');
\`\`\`

## Blockquote

> This is a blockquote.
> It can span multiple lines.

## Table

| Feature | Status | Description |
|---------|--------|-------------|
| Markdown | ‚úÖ | Full support |
| Mermaid | ‚úÖ | Diagram creation |
| Math | ‚úÖ | LaTeX equations |
| Dark Mode | ‚úÖ | Theme toggle |

---

## Math Equations (LaTeX)

### Inline Math

The quadratic formula is $x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$ which solves $ax^2 + bx + c = 0$.

Einstein's famous equation: $E = mc^2$

### Block Math

The Gaussian integral:

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

Euler's identity:

$$e^{i\\pi} + 1 = 0$$

Matrix example:

$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax + by \\\\ cx + dy \\end{pmatrix}$$

Summation notation:

$$\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}$$

---

## Mermaid Diagrams

### Flowchart

\`\`\`mermaid
flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Process A]
    B -->|No| D[Process B]
    C --> E[End]
    D --> E
\`\`\`

### Sequence Diagram

\`\`\`mermaid
sequenceDiagram
    User->>Browser: Access URL
    Browser->>Server: HTTP Request
    Server->>Database: Fetch Data
    Database-->>Server: Return Data
    Server-->>Browser: HTML Response
    Browser-->>User: Display Page
\`\`\`

### Class Diagram

\`\`\`mermaid
classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat
\`\`\`

### Pie Chart

\`\`\`mermaid
pie title Project Progress
    "Completed" : 45
    "In Progress" : 30
    "Not Started" : 25
\`\`\`

---

## Tips

1. **File Operations**: Use the File menu to open/save files
2. **Resize Panels**: Drag the center bar to resize
3. **Export Diagrams**: Hover over diagrams for PNG/SVG buttons
4. **Print**: Only the preview is printed
5. **Theme**: Toggle dark/light mode with the button in the top right

Enjoy! üöÄ
`
            },
            ja: {
                file: "„Éï„Ç°„Ç§„É´",
                newFile: "Êñ∞Ë¶è‰ΩúÊàê",
                openFile: "Èñã„Åè",
                save: "‰∏äÊõ∏„Åç‰øùÂ≠ò",
                saveAs: "ÂêçÂâç„Çí‰ªò„Åë„Å¶‰øùÂ≠ò",
                print: "Âç∞Âà∑",
                samples: "„Çµ„É≥„Éó„É´",
                sampleCode: "„Çµ„É≥„Éó„É´„Ç≥„Éº„Éâ",
                mermaidDiagrams: "MermaidÂõ≥",
                mathFormulas: "Êï∞Âºè",
                sampleInserted: "„Çµ„É≥„Éó„É´„ÇíÊåøÂÖ•„Åó„Åæ„Åó„Åü",
                undo: "ÂÖÉ„Å´Êàª„Åô",
                redo: "„ÇÑ„ÇäÁõ¥„Åô",
                nothingToUndo: "ÂÖÉ„Å´Êàª„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
                nothingToRedo: "„ÇÑ„ÇäÁõ¥„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
                editor: "„Ç®„Éá„Ç£„Çø",
                preview: "„Éó„É¨„Éì„É•„Éº",
                editorPlaceholder: "Markdown„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...",
                characters: "ÊñáÂ≠ó",
                lines: "Ë°å",
                diagrams: "Âõ≥",
                equations: "Êï∞Âºè",
                language: "Ë®ÄË™û",
                colorTheme: "„Ç´„É©„Éº„ÉÜ„Éº„Éû",
                indentSize: "„Ç§„É≥„Éá„É≥„ÉàÂπÖ",
                darkLightMode: "„ÉÄ„Éº„ÇØ/„É©„Ç§„Éà„É¢„Éº„Éâ",
                newFileCreated: "Êñ∞Ë¶è„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü",
                fileOpened: "Èñã„Åç„Åæ„Åó„Åü: ",
                fileSaved: "‰øùÂ≠ò„Åó„Åæ„Åó„Åü",
                fileSavedAs: "‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ",
                fileDownloaded: "„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü: ",
                unsavedChanges: "‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü",
                pngDownloaded: "PNG„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü",
                svgDownloaded: "SVG„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü",
                pngExportFailed: "PNG„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",
                svgNotFound: "SVGË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì",
                diagramNotFound: "Âõ≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì",
                equationNotFound: "Êï∞Âºè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì",
                fileReadFailed: "„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",
                colorThemeChanged: "„Ç´„É©„Éº„ÉÜ„Éº„Éû„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü",
                sampleMarkdown: `# Markdown Editor Pro „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ

„Åì„ÅÆ„Ç®„Éá„Ç£„Çø„ÅØ **Markdown** „Å® **MermaidÂõ≥** „Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

## Âü∫Êú¨ÁöÑ„Å™Êõ∏Âºè

„ÉÜ„Ç≠„Çπ„Éà„ÅØ **Â§™Â≠ó** „ÇÑ *Êñú‰Ωì* „Å´„Åß„Åç„Åæ„Åô„ÄÇ„Åæ„Åü„ÄÅ\`„Ç§„É≥„É©„Ç§„É≥„Ç≥„Éº„Éâ\` „ÇÇ‰Ωø„Åà„Åæ„Åô„ÄÇ

### „É™„Çπ„Éà

- È†ÖÁõÆ1
- È†ÖÁõÆ2
  - „Éç„Çπ„Éà„Åï„Çå„ÅüÈ†ÖÁõÆ
- È†ÖÁõÆ3

### Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà

1. ÊúÄÂàù„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó
2. Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó
3. ÊúÄÂæå„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó

## „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ

\`\`\`javascript
function greeting(name) {
    console.log(\`Hello, \${name}!\`);
}

greeting('World');
\`\`\`

## ÂºïÁî®

> „Åì„Çå„ÅØÂºïÁî®„Éñ„É≠„ÉÉ„ÇØ„Åß„Åô„ÄÇ
> Ë§áÊï∞Ë°å„Å´„Çè„Åü„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ

## „ÉÜ„Éº„Éñ„É´

| Ê©üËÉΩ | Áä∂ÊÖã | Ë™¨Êòé |
|------|------|------|
| Markdown | ‚úÖ | ÂÆåÂÖ®„Çµ„Éù„Éº„Éà |
| Mermaid | ‚úÖ | Âõ≥Ë°®‰ΩúÊàê |
| Êï∞Âºè | ‚úÖ | LaTeXÊï∞Âºè |
| „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ | ‚úÖ | „ÉÜ„Éº„ÉûÂàáÊõø |

---

## Êï∞Âºè (LaTeX)

### „Ç§„É≥„É©„Ç§„É≥Êï∞Âºè

‰∫åÊ¨°ÊñπÁ®ãÂºè„ÅÆËß£„ÅÆÂÖ¨Âºè„ÅØ $x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$ „Åß„ÄÅ$ax^2 + bx + c = 0$ „ÇíËß£„Åç„Åæ„Åô„ÄÇ

„Ç¢„Ç§„É≥„Ç∑„É•„Çø„Ç§„É≥„ÅÆÊúâÂêç„Å™ÊñπÁ®ãÂºè: $E = mc^2$

### „Éñ„É≠„ÉÉ„ÇØÊï∞Âºè

„Ç¨„Ç¶„ÇπÁ©çÂàÜ:

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

„Ç™„Ç§„É©„Éº„ÅÆÁ≠âÂºè:

$$e^{i\\pi} + 1 = 0$$

Ë°åÂàó„ÅÆ‰æã:

$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax + by \\\\ cx + dy \\end{pmatrix}$$

Á∑èÂíåË®òÂè∑:

$$\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}$$

---

## Mermaid Âõ≥Ë°®

### „Éï„É≠„Éº„ÉÅ„É£„Éº„Éà

\`\`\`mermaid
flowchart TD
    A[ÈñãÂßã] --> B{Êù°‰ª∂ÂàÜÂ≤ê}
    B -->|Yes| C[Âá¶ÁêÜA]
    B -->|No| D[Âá¶ÁêÜB]
    C --> E[ÁµÇ‰∫Ü]
    D --> E
\`\`\`

### „Ç∑„Éº„Ç±„É≥„ÇπÂõ≥

\`\`\`mermaid
sequenceDiagram
    User->>Browser: URL„Å´„Ç¢„ÇØ„Çª„Çπ
    Browser->>Server: HTTP„É™„ÇØ„Ç®„Çπ„Éà
    Server->>Database: „Éá„Éº„ÇøÂèñÂæó
    Database-->>Server: „Éá„Éº„ÇøËøîÂç¥
    Server-->>Browser: HTML„É¨„Çπ„Éù„É≥„Çπ
    Browser-->>User: „Éö„Éº„Ç∏Ë°®Á§∫
\`\`\`

### „ÇØ„É©„ÇπÂõ≥

\`\`\`mermaid
classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat
\`\`\`

### ÂÜÜ„Ç∞„É©„Éï

\`\`\`mermaid
pie title „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÈÄ≤Êçó
    "ÂÆå‰∫Ü" : 45
    "ÈÄ≤Ë°å‰∏≠" : 30
    "Êú™ÁùÄÊâã" : 25
\`\`\`

---

## ‰Ωø„ÅÑÊñπ„ÅÆ„Éí„É≥„Éà

1. **„Éï„Ç°„Ç§„É´Êìç‰Ωú**: „ÉÑ„Éº„É´„Éê„Éº„ÅÆ„Äå„Éï„Ç°„Ç§„É´„Äç„É°„Éã„É•„Éº„Åã„ÇâÈñã„Åè„Éª‰øùÂ≠ò„Åå„Åß„Åç„Åæ„Åô
2. **„É™„Çµ„Ç§„Ç∫**: ‰∏≠Â§Æ„ÅÆ„Éê„Éº„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Éë„Éç„É´„Çµ„Ç§„Ç∫„ÇíÂ§âÊõ¥
3. **MermaidÂõ≥„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà**: Âõ≥„Å´„Éû„Ç¶„Çπ„Çí‰πó„Åõ„Çã„Å® PNG/SVG „Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
4. **Âç∞Âà∑**: „Éó„É¨„Éì„É•„ÉºÈÉ®ÂàÜ„ÅÆ„Åø„ÅåÂç∞Âà∑„Åï„Çå„Åæ„Åô
5. **„ÉÜ„Éº„Éû**: Âè≥‰∏ä„ÅÆ„Éú„Çø„É≥„Åß„ÉÄ„Éº„ÇØ/„É©„Ç§„Éà„É¢„Éº„Éâ„ÇíÂàáÊõø

„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑÔºÅ üöÄ
`
            },
            zh: {
                file: "Êñá‰ª∂",
                newFile: "Êñ∞Âª∫",
                openFile: "ÊâìÂºÄ",
                save: "‰øùÂ≠ò",
                saveAs: "Âè¶Â≠ò‰∏∫",
                print: "ÊâìÂç∞",
                samples: "Á§∫‰æã",
                sampleCode: "Á§∫‰æã‰ª£Á†Å",
                mermaidDiagrams: "Mermaid ÂõæË°®",
                mathFormulas: "Êï∞Â≠¶ÂÖ¨Âºè",
                sampleInserted: "Â∑≤ÊèíÂÖ•Á§∫‰æã",
                undo: "Êí§ÈîÄ",
                redo: "ÈáçÂÅö",
                nothingToUndo: "Ê≤°ÊúâÂèØÊí§ÈîÄÁöÑÊìç‰Ωú",
                nothingToRedo: "Ê≤°ÊúâÂèØÈáçÂÅöÁöÑÊìç‰Ωú",
                editor: "ÁºñËæëÂô®",
                preview: "È¢ÑËßà",
                editorPlaceholder: "Âú®Ê≠§ËæìÂÖ• Markdown...",
                characters: "Â≠óÁ¨¶",
                lines: "Ë°å",
                diagrams: "ÂõæË°®",
                equations: "ÂÖ¨Âºè",
                language: "ËØ≠Ë®Ä",
                colorTheme: "È¢úËâ≤‰∏ªÈ¢ò",
                indentSize: "Áº©ËøõÂ§ßÂ∞è",
                darkLightMode: "Ê∑±Ëâ≤/ÊµÖËâ≤Ê®°Âºè",
                newFileCreated: "Â∑≤ÂàõÂª∫Êñ∞Êñá‰ª∂",
                fileOpened: "Â∑≤ÊâìÂºÄ: ",
                fileSaved: "Â∑≤‰øùÂ≠ò",
                fileSavedAs: "Â∑≤‰øùÂ≠ò‰∏∫: ",
                fileDownloaded: "Â∑≤‰∏ãËΩΩ: ",
                unsavedChanges: "ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ„ÄÇÁ°ÆÂÆöË¶ÅÊñ∞Âª∫Êñá‰ª∂ÂêóÔºü",
                pngDownloaded: "PNG Â∑≤‰∏ãËΩΩ",
                svgDownloaded: "SVG Â∑≤‰∏ãËΩΩ",
                pngExportFailed: "PNG ÂØºÂá∫Â§±Ë¥•",
                svgNotFound: "Êú™ÊâæÂà∞ SVG ÂÖÉÁ¥†",
                diagramNotFound: "Êú™ÊâæÂà∞ÂõæË°®",
                equationNotFound: "Êú™ÊâæÂà∞ÂÖ¨Âºè",
                fileReadFailed: "Êñá‰ª∂ËØªÂèñÂ§±Ë¥•",
                colorThemeChanged: "È¢úËâ≤‰∏ªÈ¢òÂ∑≤Êõ¥Êîπ",
                sampleMarkdown: `# Ê¨¢Ëøé‰ΩøÁî® Markdown Editor ProÔºÅ

Êú¨ÁºñËæëÂô®ÊîØÊåÅ **Markdown** Âíå **Mermaid ÂõæË°®**„ÄÇ

## Âü∫Êú¨Ê†ºÂºè

ÊñáÊú¨ÂèØ‰ª•ËÆæÁΩÆ‰∏∫ **Á≤ó‰Ωì** Êàñ *Êñú‰Ωì*„ÄÇËøòÂèØ‰ª•‰ΩøÁî® \`Ë°åÂÜÖ‰ª£Á†Å\`„ÄÇ

### ÂàóË°®

- È°πÁõÆ 1
- È°πÁõÆ 2
  - ÂµåÂ•óÈ°πÁõÆ
- È°πÁõÆ 3

### ÊúâÂ∫èÂàóË°®

1. Á¨¨‰∏ÄÊ≠•
2. Á¨¨‰∫åÊ≠•
3. ÊúÄÂêé‰∏ÄÊ≠•

## ‰ª£Á†ÅÂùó

\`\`\`javascript
function greeting(name) {
    console.log(\`Hello, \${name}!\`);
}

greeting('World');
\`\`\`

## ÂºïÁî®

> ËøôÊòØ‰∏Ä‰∏™ÂºïÁî®Âùó„ÄÇ
> ÂèØ‰ª•Ë∑®Ë∂äÂ§öË°å„ÄÇ

## Ë°®Ê†º

| ÂäüËÉΩ | Áä∂ÊÄÅ | ÊèèËø∞ |
|------|------|------|
| Markdown | ‚úÖ | ÂÆåÂÖ®ÊîØÊåÅ |
| Mermaid | ‚úÖ | ÂõæË°®ÂàõÂª∫ |
| Êï∞Â≠¶ÂÖ¨Âºè | ‚úÖ | LaTeXÂÖ¨Âºè |
| Ê∑±Ëâ≤Ê®°Âºè | ‚úÖ | ‰∏ªÈ¢òÂàáÊç¢ |

---

## Êï∞Â≠¶ÂÖ¨Âºè (LaTeX)

### Ë°åÂÜÖÂÖ¨Âºè

‰∫åÊ¨°ÊñπÁ®ãÁöÑÊ±ÇÊ†πÂÖ¨ÂºèÊòØ $x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$ÔºåÁî®‰∫éÊ±ÇËß£ $ax^2 + bx + c = 0$„ÄÇ

Áà±Âõ†ÊñØÂù¶ÁöÑËëóÂêçÊñπÁ®ãÔºö$E = mc^2$

### ÂùóÁ∫ßÂÖ¨Âºè

È´òÊñØÁßØÂàÜÔºö

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

Ê¨ßÊãâÊÅíÁ≠âÂºèÔºö

$$e^{i\\pi} + 1 = 0$$

Áü©ÈòµÁ§∫‰æãÔºö

$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax + by \\\\ cx + dy \\end{pmatrix}$$

Ê±ÇÂíåÁ¨¶Âè∑Ôºö

$$\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}$$

---

## Mermaid ÂõæË°®

### ÊµÅÁ®ãÂõæ

\`\`\`mermaid
flowchart TD
    A[ÂºÄÂßã] --> B{Êù°‰ª∂Âà§Êñ≠}
    B -->|ÊòØ| C[Â§ÑÁêÜ A]
    B -->|Âê¶| D[Â§ÑÁêÜ B]
    C --> E[ÁªìÊùü]
    D --> E
\`\`\`

### Êó∂Â∫èÂõæ

\`\`\`mermaid
sequenceDiagram
    User->>Browser: ËÆøÈóÆ URL
    Browser->>Server: HTTP ËØ∑Ê±Ç
    Server->>Database: Ëé∑ÂèñÊï∞ÊçÆ
    Database-->>Server: ËøîÂõûÊï∞ÊçÆ
    Server-->>Browser: HTML ÂìçÂ∫î
    Browser-->>User: ÊòæÁ§∫È°µÈù¢
\`\`\`

### Á±ªÂõæ

\`\`\`mermaid
classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat
\`\`\`

### È•ºÂõæ

\`\`\`mermaid
pie title È°πÁõÆËøõÂ∫¶
    "Â∑≤ÂÆåÊàê" : 45
    "ËøõË°å‰∏≠" : 30
    "Êú™ÂºÄÂßã" : 25
\`\`\`

---

## ‰ΩøÁî®ÊèêÁ§∫

1. **Êñá‰ª∂Êìç‰Ωú**Ôºö‰ΩøÁî®Êñá‰ª∂ËèúÂçïÊâìÂºÄ/‰øùÂ≠òÊñá‰ª∂
2. **Ë∞ÉÊï¥Â§ßÂ∞è**ÔºöÊãñÂä®‰∏≠Èó¥ÂàÜÈöîÊù°Ë∞ÉÊï¥Èù¢ÊùøÂ§ßÂ∞è
3. **ÂØºÂá∫ÂõæË°®**ÔºöÂ∞ÜÈº†Ê†áÊÇ¨ÂÅúÂú®ÂõæË°®‰∏äÂèØÊòæÁ§∫ PNG/SVG ÊåâÈíÆ
4. **ÊâìÂç∞**Ôºö‰ªÖÊâìÂç∞È¢ÑËßàÈÉ®ÂàÜ
5. **‰∏ªÈ¢ò**ÔºöÁÇπÂáªÂè≥‰∏äËßíÊåâÈíÆÂàáÊç¢Ê∑±Ëâ≤/ÊµÖËâ≤Ê®°Âºè

Á•ùÊÇ®‰ΩøÁî®ÊÑâÂø´ÔºÅ üöÄ
`
            }
        };

        const langConfig = {
            en: { flag: 'üá∫üá∏', code: 'EN' },
            ja: { flag: 'üáØüáµ', code: 'JA' },
            zh: { flag: 'üá®üá≥', code: 'ZH' }
        };

        let currentLang = 'en';

        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        function updateUILanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                el.title = t(key);
            });
            const config = langConfig[currentLang];
            document.getElementById('current-lang-flag').textContent = config.flag;
            document.getElementById('current-lang-code').textContent = config.code;
            document.querySelectorAll('.lang-item').forEach(item => {
                item.classList.toggle('active', item.dataset.lang === currentLang);
            });
            document.documentElement.lang = currentLang;
        }

        function setLanguage(lang, updateContent = true) {
            const previousLang = currentLang;
            currentLang = lang;
            updateUILanguage();
            if (updateContent) {
                const editorContent = editor.value.trim();
                const isDefaultContent = Object.values(translations).some(
                    t => editorContent === t.sampleMarkdown.trim()
                );
                if (!editorContent || isDefaultContent) {
                    editor.value = t('sampleMarkdown');
                    updatePreview();
                }
            }
            localStorage.setItem('language', lang);
            document.getElementById('lang-popup').classList.remove('open');
        }

        function toggleLangPopup() {
            document.getElementById('lang-popup').classList.toggle('open');
            document.getElementById('color-palette').classList.remove('open');
        }

        // State
        let currentFileName = 'untitled.md';
        let fileHandle = null;
        let isDirty = false;
        let mermaidCounter = 0;

        // Undo/Redo state (unlimited history)
        let undoStack = [];
        let redoStack = [];
        let isUndoRedo = false;
        let lastSavedState = null;
        const DEBOUNCE_DELAY = 300; // ms
        let debounceTimer = null;

        // DOM Elements
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const charCount = document.getElementById('char-count');
        const lineCount = document.getElementById('line-count');
        const mermaidCount = document.getElementById('mermaid-count');
        const resizer = document.getElementById('resizer');
        const editorPanel = document.getElementById('editor-panel');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved language preference (default: English)
            const savedLang = localStorage.getItem('language') || 'en';
            currentLang = savedLang;
            updateUILanguage();
            
            editor.value = t('sampleMarkdown');
            updatePreview();
            updateStats();
            initResizer();
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            }
            
            // Check for saved color theme
            const savedColor = localStorage.getItem('colorTheme') || 'indigo';
            setColorTheme(savedColor, false);

            // Initialize indent size from localStorage
            initIndentSize();

            // Initialize undo/redo
            initUndoRedo();

            // Initialize font settings
            initFontSettings();

            updateMermaidTheme();
        });

        // Marked configuration
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            editor.value = t('sampleMarkdown');
            updatePreview();
            updateStats();
            initResizer();
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            }
            
            // Check for saved color theme
            const savedColor = localStorage.getItem('colorTheme') || 'indigo';
            setColorTheme(savedColor, false);
            
            updateMermaidTheme();
        });

        // Undo/Redo Functions
        function saveState() {
            if (isUndoRedo) return;

            const currentState = {
                content: editor.value,
                selectionStart: editor.selectionStart,
                selectionEnd: editor.selectionEnd
            };

            // Don't save if content hasn't changed
            if (lastSavedState && lastSavedState.content === currentState.content) {
                return;
            }

            undoStack.push(currentState);
            redoStack = []; // Clear redo stack on new action
            lastSavedState = currentState;
            updateUndoRedoButtons();
        }

        function saveStateDebounced() {
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            debounceTimer = setTimeout(() => {
                saveState();
            }, DEBOUNCE_DELAY);
        }

        function performUndo() {
            if (undoStack.length === 0) {
                showToast(t('nothingToUndo'));
                return;
            }

            // Save current state to redo stack
            const currentState = {
                content: editor.value,
                selectionStart: editor.selectionStart,
                selectionEnd: editor.selectionEnd
            };
            redoStack.push(currentState);

            // Restore previous state
            const prevState = undoStack.pop();
            isUndoRedo = true;
            editor.value = prevState.content;
            editor.selectionStart = prevState.selectionStart;
            editor.selectionEnd = prevState.selectionEnd;
            lastSavedState = prevState;
            isUndoRedo = false;

            updatePreview();
            updateStats();
            updateUndoRedoButtons();
        }

        function performRedo() {
            if (redoStack.length === 0) {
                showToast(t('nothingToRedo'));
                return;
            }

            // Save current state to undo stack
            const currentState = {
                content: editor.value,
                selectionStart: editor.selectionStart,
                selectionEnd: editor.selectionEnd
            };
            undoStack.push(currentState);

            // Restore next state
            const nextState = redoStack.pop();
            isUndoRedo = true;
            editor.value = nextState.content;
            editor.selectionStart = nextState.selectionStart;
            editor.selectionEnd = nextState.selectionEnd;
            lastSavedState = nextState;
            isUndoRedo = false;

            updatePreview();
            updateStats();
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');

            if (undoBtn) {
                undoBtn.style.opacity = undoStack.length > 0 ? '1' : '0.5';
            }
            if (redoBtn) {
                redoBtn.style.opacity = redoStack.length > 0 ? '1' : '0.5';
            }
        }

        function initUndoRedo() {
            // Save initial state
            lastSavedState = {
                content: editor.value,
                selectionStart: 0,
                selectionEnd: 0
            };
            updateUndoRedoButtons();
        }

        // Scroll textarea to keep cursor visible
        function scrollCursorIntoView() {
            const cursorPos = editor.selectionStart;

            // Force browser to recalculate and show cursor by refocusing
            requestAnimationFrame(() => {
                // Blur and refocus to force cursor redraw
                editor.blur();
                editor.focus();

                // Restore cursor position and trigger native scroll behavior
                editor.setSelectionRange(cursorPos, cursorPos);
            });
        }

        // Preview update scheduling with requestIdleCallback + requestAnimationFrame
        let previewUpdatePending = false;
        let previewIdleCallbackId = null;
        const useIdleCallback = 'requestIdleCallback' in window;

        function schedulePreviewUpdate() {
            // If update is already pending, skip (coalesce multiple calls)
            if (previewUpdatePending) return;
            previewUpdatePending = true;

            // Two-phase scheduling:
            // 1. Wait for browser idle time (requestIdleCallback)
            // 2. Sync with next paint frame (requestAnimationFrame)
            function executeUpdate() {
                // Use requestAnimationFrame to sync with browser's paint cycle
                requestAnimationFrame(() => {
                    previewUpdatePending = false;
                    previewIdleCallbackId = null;
                    updatePreview();
                });
            }

            // Use requestIdleCallback for non-blocking preview updates
            // Falls back to setTimeout for Safari compatibility
            if (useIdleCallback) {
                previewIdleCallbackId = requestIdleCallback(executeUpdate, { timeout: 500 }); // Max 500ms wait
            } else {
                // Fallback for Safari
                previewIdleCallbackId = setTimeout(executeUpdate, 100);
            }
        }

        // Editor input handler
        editor.addEventListener('input', () => {
            isDirty = true;
            saveStateDebounced();
            schedulePreviewUpdate();
            updateStats();
        });

        // Tab key, Enter key, and Undo/Redo keyboard shortcuts
        editor.addEventListener('keydown', (e) => {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const value = editor.value;

            // Ctrl+Z - Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                performUndo();
                return;
            }

            // Ctrl+Y or Ctrl+Shift+Z - Redo
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey) || (e.key === 'Z' && e.shiftKey))) {
                e.preventDefault();
                performRedo();
                return;
            }

            // Enter key - preserve current line's indent
            if (e.key === 'Enter') {
                e.preventDefault();

                // Find the start of the current line
                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                const lineContent = value.substring(lineStart, start);

                // Extract leading whitespace (spaces and tabs)
                const indentMatch = lineContent.match(/^[\t ]*/);
                const indent = indentMatch ? indentMatch[0] : '';

                // Insert newline with the same indent
                const insertion = '\n' + indent;
                saveState(); // Save state before change
                editor.value = value.substring(0, start) + insertion + value.substring(end);
                editor.selectionStart = editor.selectionEnd = start + insertion.length;

                // Scroll cursor into view
                scrollCursorIntoView();

                schedulePreviewUpdate();
                return;
            }

            // Tab key handling
            if (e.key === 'Tab') {
                e.preventDefault();
                saveState(); // Save state before change

                // Check if there's a selection spanning multiple lines
                const selectedText = value.substring(start, end);
                const hasMultipleLines = selectedText.includes('\n') || start !== end;

                if (hasMultipleLines && start !== end) {
                    // Multi-line selection: indent/outdent all selected lines
                    const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                    const lineEnd = value.indexOf('\n', end);
                    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

                    const selectedLines = value.substring(lineStart, actualLineEnd);
                    const lines = selectedLines.split('\n');

                    let newLines;
                    let cursorAdjustment;

                    const indentStr = ' '.repeat(indentSize);

                    if (e.shiftKey) {
                        // Shift+Tab: remove indent (up to indentSize spaces or 1 tab)
                        newLines = lines.map(line => {
                            if (line.startsWith('\t')) {
                                return line.substring(1);
                            } else if (line.startsWith(indentStr)) {
                                return line.substring(indentSize);
                            } else {
                                // Remove as many leading spaces as possible (up to indentSize)
                                const match = line.match(new RegExp(`^( {1,${indentSize}})`));
                                return match ? line.substring(match[1].length) : line;
                            }
                        });
                        // Calculate cursor adjustment for first line
                        const firstLineChange = lines[0].length - newLines[0].length;
                        cursorAdjustment = -firstLineChange;
                    } else {
                        // Tab: add indent (indentSize spaces)
                        newLines = lines.map(line => indentStr + line);
                        cursorAdjustment = indentSize;
                    }

                    const newText = newLines.join('\n');
                    editor.value = value.substring(0, lineStart) + newText + value.substring(actualLineEnd);

                    // Adjust selection to cover the modified lines
                    const newStart = Math.max(lineStart, start + cursorAdjustment);
                    const lengthDiff = newText.length - selectedLines.length;
                    editor.selectionStart = newStart;
                    editor.selectionEnd = actualLineEnd + lengthDiff;
                } else {
                    // Single cursor or single line
                    const indentStr = ' '.repeat(indentSize);

                    if (e.shiftKey) {
                        // Shift+Tab: remove indent from current line
                        const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                        const lineContent = value.substring(lineStart);

                        let removeCount = 0;
                        if (lineContent.startsWith('\t')) {
                            removeCount = 1;
                        } else if (lineContent.startsWith(indentStr)) {
                            removeCount = indentSize;
                        } else {
                            const match = lineContent.match(new RegExp(`^( {1,${indentSize}})`));
                            removeCount = match ? match[1].length : 0;
                        }

                        if (removeCount > 0) {
                            editor.value = value.substring(0, lineStart) + value.substring(lineStart + removeCount);
                            editor.selectionStart = editor.selectionEnd = Math.max(lineStart, start - removeCount);
                        }
                    } else {
                        // Tab: insert indentSize spaces at cursor
                        editor.value = value.substring(0, start) + indentStr + value.substring(end);
                        editor.selectionStart = editor.selectionEnd = start + indentSize;
                    }
                }
                schedulePreviewUpdate();
                return;
            }

            // Keyboard shortcuts
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    saveFile();
                } else if (e.key === 'o') {
                    e.preventDefault();
                    openFile();
                }
            }
        });

        // Update preview
        let mathBlockCounter = 0;

        // Cache for Mermaid diagrams - key is the code hash, value is SVG
        const mermaidCache = new Map(); // code -> svg

        // Cache for KaTeX math - key is the code hash, value is rendered HTML
        const mathCache = new Map(); // code -> html

        // Intersection Observer for lazy rendering
        let lazyRenderObserver = null;

        function initLazyRenderObserver() {
            if (lazyRenderObserver) {
                lazyRenderObserver.disconnect();
            }

            lazyRenderObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;

                        if (el.classList.contains('mermaid-lazy')) {
                            // Render mermaid diagram
                            renderLazyMermaid(el);
                        } else if (el.classList.contains('math-lazy')) {
                            // Render math equation
                            renderLazyMath(el);
                        }

                        // Stop observing once rendered
                        lazyRenderObserver.unobserve(el);
                    }
                });
            }, {
                root: preview,
                rootMargin: '100px', // Start rendering slightly before entering viewport
                threshold: 0
            });
        }

        async function renderLazyMermaid(el) {
            const code = el.getAttribute('data-mermaid-code');
            const hash = el.getAttribute('data-hash');

            if (!code) return;

            el.textContent = decodeURIComponent(code);
            el.classList.remove('mermaid-lazy');
            el.classList.add('mermaid');

            try {
                await mermaid.run({ nodes: [el] });

                // Cache the rendered SVG
                if (hash && el.innerHTML.includes('<svg')) {
                    mermaidCache.set(hash, el.innerHTML);
                }
            } catch (error) {
                console.error('Mermaid lazy rendering error:', error);
            }
        }

        function renderLazyMath(el) {
            const mathSrc = decodeURIComponent(el.getAttribute('data-math-src') || '');
            const hash = el.getAttribute('data-math-hash');
            const isBlock = el.classList.contains('math-content');

            if (!mathSrc) return;

            try {
                const rendered = katex.renderToString(mathSrc, {
                    displayMode: isBlock,
                    throwOnError: false,
                    errorColor: '#cc0000'
                });
                el.innerHTML = rendered;
                el.classList.remove('math-lazy', 'math-to-render');
                el.classList.add('math-cached');

                // Cache the rendered HTML
                if (hash) {
                    mathCache.set(hash, rendered);
                }
            } catch (error) {
                console.error('KaTeX lazy rendering error:', error);
            }
        }

        // Simple hash function for caching
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString();
        }

        async function updatePreview() {
            // Save scroll position before update
            const scrollTop = preview.scrollTop;
            const scrollHeight = preview.scrollHeight;
            const clientHeight = preview.clientHeight;
            const wasAtBottom = scrollTop + clientHeight >= scrollHeight - 10;

            let content = editor.value;
            mermaidCounter = 0;
            mathBlockCounter = 0;
            let mathCounter = 0;

            // Protect code blocks from math processing
            const codeBlocks = [];
            content = content.replace(/```[\s\S]*?```/g, (match) => {
                const placeholder = `%%CODEBLOCK_${codeBlocks.length}%%`;
                codeBlocks.push(match);
                return placeholder;
            });

            // Protect inline code from math processing
            const inlineCodes = [];
            content = content.replace(/`[^`]+`/g, (match) => {
                const placeholder = `%%INLINECODE_${inlineCodes.length}%%`;
                inlineCodes.push(match);
                return placeholder;
            });

            // Process block math ($$...$$) - count them and add download buttons
            const blockMathMatches = content.match(/\$\$[\s\S]*?\$\$/g) || [];
            mathCounter += blockMathMatches.length;
            content = content.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                const id = `math-${mathBlockCounter++}`;
                const trimmedMath = math.trim();
                const mathHash = hashCode(trimmedMath + '_block');
                const cachedHtml = mathCache.get(mathHash);

                if (cachedHtml) {
                    // Use cached rendered math
                    return `<div class="math-container" data-math-id="${id}">
                        <div class="math-actions">
                            <button class="math-action-btn" onclick="downloadMathPNG('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21,15 16,10 5,21"/>
                                </svg>
                                PNG
                            </button>
                            <button class="math-action-btn" onclick="downloadMathSVG('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                    <polyline points="2,17 12,22 22,17"/>
                                    <polyline points="2,12 12,17 22,12"/>
                                </svg>
                                SVG
                            </button>
                        </div>
                        <div class="math-content math-cached" id="${id}">${cachedHtml}</div>
                    </div>`;
                }

                return `<div class="math-container" data-math-id="${id}">
                    <div class="math-actions">
                        <button class="math-action-btn" onclick="downloadMathPNG('${id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21,15 16,10 5,21"/>
                            </svg>
                            PNG
                        </button>
                        <button class="math-action-btn" onclick="downloadMathSVG('${id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                <polyline points="2,17 12,22 22,17"/>
                                <polyline points="2,12 12,17 22,12"/>
                            </svg>
                            SVG
                        </button>
                    </div>
                    <div class="math-content math-lazy math-placeholder" id="${id}" data-math-hash="${mathHash}" data-math-src="${encodeURIComponent(trimmedMath)}">
                        <div class="lazy-placeholder-text">$$${math}$$</div>
                    </div>
                </div>`;
            });

            // Process inline math ($...$) - count them (but not $$)
            const inlineMathMatches = content.match(/(?<!\$)\$(?!\$)([^\$\n]+?)\$(?!\$)/g) || [];
            mathCounter += inlineMathMatches.length;
            content = content.replace(/(?<!\$)\$(?!\$)([^\$\n]+?)\$(?!\$)/g, (match, math) => {
                const trimmedMath = math.trim();
                const mathHash = hashCode(trimmedMath + '_inline');
                const cachedHtml = mathCache.get(mathHash);

                if (cachedHtml) {
                    return `<span class="math-inline math-cached">${cachedHtml}</span>`;
                }

                return `<span class="math-inline math-lazy" data-math-hash="${mathHash}" data-math-src="${encodeURIComponent(trimmedMath)}">$${math}$</span>`;
            });

            // Restore inline code
            inlineCodes.forEach((code, index) => {
                content = content.replace(`%%INLINECODE_${index}%%`, code);
            });

            // Restore code blocks
            codeBlocks.forEach((code, index) => {
                content = content.replace(`%%CODEBLOCK_${index}%%`, code);
            });

            // Process mermaid code blocks - extract and track for caching
            const mermaidRegex = /```mermaid\n([\s\S]*?)```/g;
            const mermaidBlocks = [];
            const mermaidCodeToRender = []; // { id, code, hash }
            let match;

            while ((match = mermaidRegex.exec(content)) !== null) {
                mermaidBlocks.push(match[1]);
            }

            // Replace mermaid blocks with placeholders
            content = content.replace(mermaidRegex, (match, code) => {
                const id = `mermaid-${mermaidCounter++}`;
                const trimmedCode = code.trim();
                const codeHash = hashCode(trimmedCode);

                // Check if we have a cached version (by code content, not by id)
                const cachedSvg = mermaidCache.get(codeHash);
                if (cachedSvg) {
                    // Use cached SVG
                    return `<div class="mermaid-container" data-mermaid-id="${id}">
                        <div class="mermaid-actions">
                            <button class="mermaid-action-btn" onclick="downloadMermaidPNG('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21,15 16,10 5,21"/>
                                </svg>
                                PNG
                            </button>
                            <button class="mermaid-action-btn" onclick="downloadMermaidSVG('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                    <polyline points="2,17 12,22 22,17"/>
                                    <polyline points="2,12 12,17 22,12"/>
                                </svg>
                                SVG
                            </button>
                        </div>
                        <div class="mermaid-cached" id="${id}">${cachedSvg}</div>
                    </div>`;
                }

                // Not cached, need to render (mark as lazy for Intersection Observer)
                mermaidCodeToRender.push({ id, code: trimmedCode, hash: codeHash });

                return `<div class="mermaid-container" data-mermaid-id="${id}">
                    <div class="mermaid-actions">
                        <button class="mermaid-action-btn" onclick="downloadMermaidPNG('${id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21,15 16,10 5,21"/>
                            </svg>
                            PNG
                        </button>
                        <button class="mermaid-action-btn" onclick="downloadMermaidSVG('${id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12,2 2,7 12,12 22,7 12,2"/>
                                <polyline points="2,17 12,22 22,17"/>
                                <polyline points="2,12 12,17 22,12"/>
                            </svg>
                            SVG
                        </button>
                    </div>
                    <div class="mermaid-lazy mermaid-placeholder" id="${id}" data-hash="${codeHash}" data-mermaid-code="${encodeURIComponent(trimmedCode)}">
                        <div class="lazy-placeholder-text">Loading diagram...</div>
                    </div>
                </div>`;
            });

            // Parse markdown
            preview.innerHTML = marked.parse(content);

            // Initialize lazy render observer
            initLazyRenderObserver();

            // Helper function to check if element is in viewport
            function isInViewport(el) {
                const rect = el.getBoundingClientRect();
                const previewRect = preview.getBoundingClientRect();
                return (
                    rect.top < previewRect.bottom + 100 && // 100px margin
                    rect.bottom > previewRect.top - 100
                );
            }

            // Process mermaid diagrams - render visible ones immediately, lazy-load others
            const lazyMermaids = preview.querySelectorAll('.mermaid-lazy');
            const visibleMermaids = [];
            const offscreenMermaids = [];

            lazyMermaids.forEach(el => {
                if (isInViewport(el)) {
                    visibleMermaids.push(el);
                } else {
                    offscreenMermaids.push(el);
                }
            });

            // Render visible mermaid diagrams immediately
            if (visibleMermaids.length > 0) {
                for (const el of visibleMermaids) {
                    const code = el.getAttribute('data-mermaid-code');
                    const hash = el.getAttribute('data-hash');
                    if (code) {
                        el.textContent = decodeURIComponent(code);
                        el.classList.remove('mermaid-lazy', 'mermaid-placeholder');
                        el.classList.add('mermaid');
                    }
                }
                try {
                    await mermaid.run({
                        nodes: visibleMermaids
                    });
                    // Cache rendered SVGs
                    visibleMermaids.forEach(el => {
                        const hash = el.getAttribute('data-hash');
                        if (hash && el.innerHTML.includes('<svg')) {
                            mermaidCache.set(hash, el.innerHTML);
                        }
                    });
                } catch (error) {
                    console.error('Mermaid rendering error:', error);
                }
            }

            // Observe offscreen mermaid diagrams for lazy loading
            offscreenMermaids.forEach(el => {
                lazyRenderObserver.observe(el);
            });

            // Process math equations - render visible ones immediately, lazy-load others
            const lazyMath = preview.querySelectorAll('.math-lazy');

            lazyMath.forEach(el => {
                if (isInViewport(el)) {
                    // Render immediately
                    const mathSrc = decodeURIComponent(el.getAttribute('data-math-src') || '');
                    const hash = el.getAttribute('data-math-hash');
                    const isBlock = el.classList.contains('math-content');

                    if (mathSrc) {
                        try {
                            const rendered = katex.renderToString(mathSrc, {
                                displayMode: isBlock,
                                throwOnError: false,
                                errorColor: '#cc0000'
                            });
                            el.innerHTML = rendered;
                            el.classList.remove('math-lazy', 'math-placeholder');
                            el.classList.add('math-cached');

                            if (hash) {
                                mathCache.set(hash, rendered);
                            }
                        } catch (error) {
                            console.error('KaTeX rendering error:', error);
                        }
                    }
                } else {
                    // Observe for lazy loading
                    lazyRenderObserver.observe(el);
                }
            });

            // Restore scroll position
            if (wasAtBottom) {
                // If user was at the bottom, stay at the bottom
                preview.scrollTop = preview.scrollHeight;
            } else {
                // Otherwise restore the previous position
                preview.scrollTop = scrollTop;
            }

            // Update counts
            mermaidCount.textContent = mermaidBlocks.length;
            document.getElementById('math-count').textContent = mathCounter;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update statistics
        function updateStats() {
            const text = editor.value;
            charCount.textContent = text.length;
            lineCount.textContent = `${text.split('\n').length} Ë°å`;
        }

        // Resizer functionality
        function initResizer() {
            let isResizing = false;
            
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizer.classList.add('active');
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const containerRect = document.querySelector('.main-container').getBoundingClientRect();
                const newWidth = e.clientX - containerRect.left;
                const percentage = (newWidth / containerRect.width) * 100;
                
                if (percentage >= 15 && percentage <= 85) {
                    editorPanel.style.width = `${percentage}%`;
                }
            });
            
            document.addEventListener('mouseup', () => {
                isResizing = false;
                resizer.classList.remove('active');
            });
        }

        // Theme toggle
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? '' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeIcon();
            updateMermaidTheme();
        }

        function updateThemeIcon() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.getElementById('theme-icon-light').style.display = isDark ? 'none' : 'block';
            document.getElementById('theme-icon-dark').style.display = isDark ? 'block' : 'none';
            
            // Update highlight.js theme
            const hljsTheme = document.getElementById('hljs-theme');
            hljsTheme.href = isDark 
                ? 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css'
                : 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css';
        }

        // Color theme
        function toggleColorPalette() {
            const palette = document.getElementById('color-palette');
            palette.classList.toggle('open');
        }

        function setColorTheme(color, save = true) {
            document.body.setAttribute('data-color', color);
            
            // Update active swatch
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.toggle('active', swatch.dataset.color === color);
            });
            
            if (save) {
                localStorage.setItem('colorTheme', color);
                showToast(t('colorThemeChanged'));
            }
            
            // Close palette
            document.getElementById('color-palette').classList.remove('open');
        }

        function getColorName(color) {
            const names = {
                indigo: '„Ç§„É≥„Éá„Ç£„Ç¥',
                blue: '„Éñ„É´„Éº',
                emerald: '„Ç®„É°„É©„É´„Éâ',
                rose: '„É≠„Éº„Ç∫',
                amber: '„Ç¢„É≥„Éê„Éº',
                cyan: '„Ç∑„Ç¢„É≥',
                violet: '„Éê„Ç§„Ç™„É¨„ÉÉ„Éà',
                slate: '„Çπ„É¨„Éº„Éà'
            };
            return names[color] || color;
        }

        function updateMermaidTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            mermaid.initialize({
                startOnLoad: false,
                theme: isDark ? 'dark' : 'default',
                securityLevel: 'loose'
            });
            // Clear mermaid cache when theme changes (SVGs have different colors)
            mermaidCache.clear();
            updatePreview();
        }

        // Dropdown toggle
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const wasOpen = dropdown.classList.contains('open');
            
            // Close all dropdowns
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            
            if (!wasOpen) {
                dropdown.classList.add('open');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            }
            if (!e.target.closest('.color-palette-btn') && !e.target.closest('.color-palette-popup')) {
                document.getElementById('color-palette').classList.remove('open');
            }
            if (!e.target.closest('.indent-btn') && !e.target.closest('.indent-popup')) {
                document.getElementById('indent-popup').classList.remove('open');
            }
            if (!e.target.closest('.font-btn') && !e.target.closest('.font-popup')) {
                document.getElementById('font-popup').classList.remove('open');
            }
        });

        // Font settings
        let editorFontSize = parseInt(localStorage.getItem('editorFontSize')) || 14;
        let editorFontFamily = localStorage.getItem('editorFontFamily') || "'JetBrains Mono', monospace";
        let previewFontSize = parseInt(localStorage.getItem('previewFontSize')) || 16;
        let previewFontFamily = localStorage.getItem('previewFontFamily') || "'Noto Sans JP', 'Noto Sans SC', sans-serif";

        function toggleFontPopup() {
            document.getElementById('font-popup').classList.toggle('open');
        }

        function setEditorFontFamily(family) {
            editorFontFamily = family;
            localStorage.setItem('editorFontFamily', family);
            editor.style.fontFamily = family;
        }

        function adjustEditorFontSize(delta) {
            editorFontSize = Math.max(10, Math.min(24, editorFontSize + delta));
            localStorage.setItem('editorFontSize', editorFontSize);
            editor.style.fontSize = editorFontSize + 'px';
            document.getElementById('editor-font-size-display').textContent = editorFontSize + 'px';
        }

        function setPreviewFontFamily(family) {
            previewFontFamily = family;
            localStorage.setItem('previewFontFamily', family);
            preview.style.fontFamily = family;
        }

        function adjustPreviewFontSize(delta) {
            previewFontSize = Math.max(12, Math.min(28, previewFontSize + delta));
            localStorage.setItem('previewFontSize', previewFontSize);
            preview.style.fontSize = previewFontSize + 'px';
            document.getElementById('preview-font-size-display').textContent = previewFontSize + 'px';
        }

        function initFontSettings() {
            // Apply saved settings
            editor.style.fontFamily = editorFontFamily;
            editor.style.fontSize = editorFontSize + 'px';
            preview.style.fontFamily = previewFontFamily;
            preview.style.fontSize = previewFontSize + 'px';

            // Update UI
            document.getElementById('editor-font-size-display').textContent = editorFontSize + 'px';
            document.getElementById('preview-font-size-display').textContent = previewFontSize + 'px';

            // Set select values
            const editorFontSelect = document.getElementById('editor-font-family');
            const previewFontSelect = document.getElementById('preview-font-family');

            // Find and select matching option
            for (let option of editorFontSelect.options) {
                if (option.value === editorFontFamily) {
                    option.selected = true;
                    break;
                }
            }
            for (let option of previewFontSelect.options) {
                if (option.value === previewFontFamily) {
                    option.selected = true;
                    break;
                }
            }
        }

        // Indent size setting
        let indentSize = parseInt(localStorage.getItem('indentSize')) || 2;

        function toggleIndentPopup() {
            document.getElementById('indent-popup').classList.toggle('open');
        }

        function setIndentSize(size) {
            indentSize = size;
            localStorage.setItem('indentSize', size);
            document.getElementById('current-indent-size').textContent = size;

            // Update active state
            document.querySelectorAll('.indent-option').forEach(opt => {
                opt.classList.toggle('active', parseInt(opt.dataset.size) === size);
            });

            document.getElementById('indent-popup').classList.remove('open');
        }

        function initIndentSize() {
            document.getElementById('current-indent-size').textContent = indentSize;
            document.querySelectorAll('.indent-option').forEach(opt => {
                opt.classList.toggle('active', parseInt(opt.dataset.size) === indentSize);
            });
        }

        // File operations
        function newFile() {
            if (isDirty && !confirm(t('unsavedChanges'))) {
                return;
            }
            editor.value = '';
            currentFileName = 'untitled.md';
            fileHandle = null;
            isDirty = false;
            updateFileNameDisplay();
            updatePreview();
            updateStats();
            showToast(t('newFileCreated'));
        }

        function openFile() {
            fileInput.click();
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                editor.value = text;
                currentFileName = file.name;
                isDirty = false;
                updateFileNameDisplay();
                updatePreview();
                updateStats();
                showToast(t('fileOpened') + file.name);
            } catch (error) {
                showToast(t('fileReadFailed'));
                console.error(error);
            }
            
            fileInput.value = '';
        });

        async function saveFile() {
            if ('showSaveFilePicker' in window && fileHandle) {
                try {
                    const writable = await fileHandle.createWritable();
                    await writable.write(editor.value);
                    await writable.close();
                    isDirty = false;
                    showToast(t('fileSaved'));
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        saveFileAs();
                    }
                }
            } else {
                saveFileAs();
            }
        }

        async function saveFileAs() {
            if ('showSaveFilePicker' in window) {
                try {
                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: currentFileName,
                        types: [{
                            description: 'Markdown Files',
                            accept: { 'text/markdown': ['.md'] }
                        }, {
                            description: 'Text Files',
                            accept: { 'text/plain': ['.txt'] }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(editor.value);
                    await writable.close();
                    
                    currentFileName = fileHandle.name;
                    isDirty = false;
                    updateFileNameDisplay();
                    showToast(t('fileSavedAs') + currentFileName);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        downloadFile();
                    }
                }
            } else {
                downloadFile();
            }
        }

        function downloadFile() {
            const blob = new Blob([editor.value], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName;
            a.click();
            URL.revokeObjectURL(url);
            isDirty = false;
            showToast(t('fileDownloaded') + currentFileName);
        }

        function updateFileNameDisplay() {
            fileNameDisplay.textContent = currentFileName;
        }

        // Print
        function printPreview() {
            // Render all lazy math equations before printing
            const lazyMathElements = preview.querySelectorAll('.math-lazy');
            lazyMathElements.forEach(el => {
                renderLazyMath(el);
            });

            // Render all lazy mermaid diagrams before printing
            const lazyMermaidElements = preview.querySelectorAll('.mermaid-lazy');
            const mermaidPromises = Array.from(lazyMermaidElements).map(el => {
                return new Promise(resolve => {
                    renderLazyMermaid(el);
                    resolve();
                });
            });

            // Wait a moment for rendering to complete, then print
            Promise.all(mermaidPromises).then(() => {
                setTimeout(() => {
                    window.print();
                }, 100);
            });
        }

        // Mermaid export functions
        async function downloadMermaidPNG(id) {
            const container = document.querySelector(`[data-mermaid-id="${id}"]`);
            if (!container) {
                showToast(t('diagramNotFound'));
                return;
            }
            
            try {
                // Hide action buttons temporarily
                const actions = container.querySelector('.mermaid-actions');
                if (actions) actions.style.display = 'none';
                
                const canvas = await html2canvas(container, {
                    backgroundColor: document.body.getAttribute('data-theme') === 'dark' ? '#1a1a2e' : '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                // Restore action buttons
                if (actions) actions.style.display = '';
                
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mermaid-diagram-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast(t('pngDownloaded'));
                }, 'image/png');
            } catch (error) {
                console.error('PNG export error:', error);
                showToast(t('pngExportFailed'));
            }
        }

        function downloadMermaidSVG(id) {
            const element = document.getElementById(id);
            if (!element) return;

            try {
                const svg = element.querySelector('svg');
                if (!svg) {
                    showToast(t('svgNotFound'));
                    return;
                }

                const svgData = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `mermaid-diagram-${Date.now()}.svg`;
                a.click();

                URL.revokeObjectURL(url);
                showToast(t('svgDownloaded'));
            } catch (error) {
                console.error('SVG export error:', error);
                showToast(t('svgNotFound'));
            }
        }

        // Math export functions
        async function downloadMathPNG(id) {
            const container = document.querySelector(`[data-math-id="${id}"]`);
            if (!container) {
                showToast(t('equationNotFound'));
                return;
            }

            try {
                // Hide action buttons temporarily
                const actions = container.querySelector('.math-actions');
                if (actions) actions.style.display = 'none';

                const canvas = await html2canvas(container, {
                    backgroundColor: document.body.getAttribute('data-theme') === 'dark' ? '#1a1a2e' : '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });

                // Restore action buttons
                if (actions) actions.style.display = '';

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `math-equation-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast(t('pngDownloaded'));
                }, 'image/png');
            } catch (error) {
                console.error('Math PNG export error:', error);
                showToast(t('pngExportFailed'));
            }
        }

        function downloadMathSVG(id) {
            const element = document.getElementById(id);
            if (!element) {
                showToast(t('equationNotFound'));
                return;
            }

            try {
                const katexElement = element.querySelector('.katex');
                if (!katexElement) {
                    showToast(t('equationNotFound'));
                    return;
                }

                // Create SVG from KaTeX rendered content
                const svgNS = "http://www.w3.org/2000/svg";
                const svg = document.createElementNS(svgNS, "svg");

                // Get bounding box
                const bbox = katexElement.getBoundingClientRect();
                const padding = 20;

                svg.setAttribute("xmlns", svgNS);
                svg.setAttribute("width", bbox.width + padding * 2);
                svg.setAttribute("height", bbox.height + padding * 2);
                svg.setAttribute("viewBox", `0 0 ${bbox.width + padding * 2} ${bbox.height + padding * 2}`);

                // Create foreignObject to embed HTML
                const foreignObject = document.createElementNS(svgNS, "foreignObject");
                foreignObject.setAttribute("x", padding);
                foreignObject.setAttribute("y", padding);
                foreignObject.setAttribute("width", bbox.width);
                foreignObject.setAttribute("height", bbox.height);

                // Clone the KaTeX element and include necessary styles
                const clonedKatex = katexElement.cloneNode(true);
                clonedKatex.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");

                // Add inline styles for standalone SVG
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                const bgColor = isDark ? '#1a1a2e' : '#ffffff';
                const textColor = isDark ? '#e8e8f0' : '#1a1a2e';

                // Add background rect
                const bgRect = document.createElementNS(svgNS, "rect");
                bgRect.setAttribute("width", "100%");
                bgRect.setAttribute("height", "100%");
                bgRect.setAttribute("fill", bgColor);
                svg.appendChild(bgRect);

                foreignObject.appendChild(clonedKatex);
                svg.appendChild(foreignObject);

                // Add KaTeX CSS link
                const style = document.createElementNS(svgNS, "style");
                style.textContent = `
                    @import url('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css');
                    .katex { color: ${textColor}; font-size: 1.2em; }
                `;
                svg.insertBefore(style, svg.firstChild);

                const svgData = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `math-equation-${Date.now()}.svg`;
                a.click();

                URL.revokeObjectURL(url);
                showToast(t('svgDownloaded'));
            } catch (error) {
                console.error('Math SVG export error:', error);
                showToast(t('svgNotFound'));
            }
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==================== Sample Code Modal ====================
        const mermaidSamples = [
            {
                name: { en: 'Flowchart', ja: '„Éï„É≠„Éº„ÉÅ„É£„Éº„Éà', zh: 'ÊµÅÁ®ãÂõæ' },
                code: `\`\`\`mermaid
flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Process A]
    B -->|No| D[Process B]
    C --> E[End]
    D --> E
\`\`\``
            },
            {
                name: { en: 'Sequence Diagram', ja: '„Ç∑„Éº„Ç±„É≥„ÇπÂõ≥', zh: 'Êó∂Â∫èÂõæ' },
                code: `\`\`\`mermaid
sequenceDiagram
    participant A as Alice
    participant B as Bob
    A->>B: Hello Bob!
    B-->>A: Hi Alice!
    A->>B: How are you?
    B-->>A: I'm fine, thanks!
\`\`\``
            },
            {
                name: { en: 'Class Diagram', ja: '„ÇØ„É©„ÇπÂõ≥', zh: 'Á±ªÂõæ' },
                code: `\`\`\`mermaid
classDiagram
    Animal <|-- Duck
    Animal <|-- Fish
    Animal : +int age
    Animal : +String gender
    Animal: +isMammal()
    Duck : +String beakColor
    Duck : +swim()
    Fish : -int sizeInFeet
    Fish : +canEat()
\`\`\``
            },
            {
                name: { en: 'State Diagram', ja: 'Áä∂ÊÖãÂõ≥', zh: 'Áä∂ÊÄÅÂõæ' },
                code: `\`\`\`mermaid
stateDiagram-v2
    [*] --> Idle
    Idle --> Processing : Start
    Processing --> Complete : Success
    Processing --> Error : Failure
    Complete --> [*]
    Error --> Idle : Retry
\`\`\``
            },
            {
                name: { en: 'Entity Relationship', ja: 'ERÂõ≥', zh: 'ERÂõæ' },
                code: `\`\`\`mermaid
erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ LINE-ITEM : contains
    CUSTOMER {
        string name
        string email
    }
    ORDER {
        int orderNumber
        date created
    }
    LINE-ITEM {
        string product
        int quantity
    }
\`\`\``
            },
            {
                name: { en: 'Gantt Chart', ja: '„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà', zh: 'ÁîòÁâπÂõæ' },
                code: `\`\`\`mermaid
gantt
    title Project Schedule
    dateFormat YYYY-MM-DD
    section Planning
    Requirements :a1, 2024-01-01, 7d
    Design       :a2, after a1, 5d
    section Development
    Coding       :a3, after a2, 14d
    Testing      :a4, after a3, 7d
\`\`\``
            },
            {
                name: { en: 'Pie Chart', ja: 'ÂÜÜ„Ç∞„É©„Éï', zh: 'È•ºÂõæ' },
                code: `\`\`\`mermaid
pie title Browser Market Share
    "Chrome" : 65
    "Safari" : 19
    "Firefox" : 4
    "Edge" : 4
    "Other" : 8
\`\`\``
            },
            {
                name: { en: 'Git Graph', ja: 'Git„Ç∞„É©„Éï', zh: 'GitÂõæ' },
                code: `\`\`\`mermaid
gitGraph
    commit
    commit
    branch develop
    checkout develop
    commit
    commit
    checkout main
    merge develop
    commit
\`\`\``
            },
            {
                name: { en: 'Mindmap', ja: '„Éû„Ç§„É≥„Éâ„Éû„ÉÉ„Éó', zh: 'ÊÄùÁª¥ÂØºÂõæ' },
                code: `\`\`\`mermaid
mindmap
  root((Project))
    Planning
      Requirements
      Design
    Development
      Frontend
      Backend
    Testing
      Unit Tests
      Integration
\`\`\``
            },
            {
                name: { en: 'Timeline', ja: '„Çø„Ç§„É†„É©„Ç§„É≥', zh: 'Êó∂Èó¥Á∫ø' },
                code: `\`\`\`mermaid
timeline
    title Project History
    2020 : Project Started
    2021 : Version 1.0 Released
    2022 : Major Update
         : New Features Added
    2023 : Version 2.0 Released
\`\`\``
            }
        ];

        const mathSamples = [
            {
                name: { en: 'Superscript', ja: '‰∏ä‰ªò„ÅçÊñáÂ≠ó', zh: '‰∏äÊ†á' },
                code: `$$x^2 + y^2 = z^2$$`
            },
            {
                name: { en: 'Subscript', ja: '‰∏ã‰ªò„ÅçÊñáÂ≠ó', zh: '‰∏ãÊ†á' },
                code: `$$a_1, a_2, a_3, \\ldots, a_n$$`
            },
            {
                name: { en: 'Fraction', ja: 'ÂàÜÊï∞', zh: 'ÂàÜÊï∞' },
                code: `$$\\frac{a}{b} + \\frac{c}{d} = \\frac{ad + bc}{bd}$$`
            },
            {
                name: { en: 'Quadratic Formula', ja: '‰∫åÊ¨°ÊñπÁ®ãÂºè„ÅÆËß£', zh: '‰∫åÊ¨°ÊñπÁ®ãÊ±ÇÊ†πÂÖ¨Âºè' },
                code: `$$x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$$`
            },
            {
                name: { en: 'Integral', ja: 'Á©çÂàÜ', zh: 'ÁßØÂàÜ' },
                code: `$$\\int_{a}^{b} f(x) \\, dx = F(b) - F(a)$$`
            },
            {
                name: { en: 'Derivative', ja: 'ÂæÆÂàÜ', zh: 'ÂæÆÂàÜ' },
                code: `$$\\frac{d}{dx} f(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$`
            },
            {
                name: { en: 'Summation', ja: 'Á∑èÂíåË®òÂè∑', zh: 'Ê±ÇÂíåÁ¨¶Âè∑' },
                code: `$$\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}$$`
            },
            {
                name: { en: 'Product', ja: 'Á∑è‰πóË®òÂè∑', zh: 'Ëøû‰πòÁ¨¶Âè∑' },
                code: `$$\\prod_{i=1}^{n} i = n!$$`
            },
            {
                name: { en: 'Matrix', ja: 'Ë°åÂàó', zh: 'Áü©Èòµ' },
                code: `$$\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax + by \\\\ cx + dy \\end{pmatrix}$$`
            },
            {
                name: { en: 'Determinant', ja: 'Ë°åÂàóÂºè', zh: 'Ë°åÂàóÂºè' },
                code: `$$\\det(A) = \\begin{vmatrix} a & b \\\\ c & d \\end{vmatrix} = ad - bc$$`
            },
            {
                name: { en: 'System of Equations', ja: 'ÈÄ£Á´ãÊñπÁ®ãÂºè', zh: 'ÊñπÁ®ãÁªÑ' },
                code: `$$\\begin{cases} ax + by = e \\\\ cx + dy = f \\end{cases}$$`
            },
            {
                name: { en: 'Limit', ja: 'Ê•µÈôê', zh: 'ÊûÅÈôê' },
                code: `$$\\lim_{x \\to \\infty} \\left(1 + \\frac{1}{x}\\right)^x = e$$`
            }
        ];

        function openSampleModal() {
            const modal = document.getElementById('sample-modal');
            modal.classList.add('open');
            renderSampleCards();
        }

        function closeSampleModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('sample-modal').classList.remove('open');
        }

        function switchSampleTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tab}`);
            });
        }

        function renderSampleCards() {
            renderMermaidSamples();
            renderMathSamples();
        }

        async function renderMermaidSamples() {
            const container = document.getElementById('mermaid-samples');
            container.innerHTML = '';

            for (let i = 0; i < mermaidSamples.length; i++) {
                const sample = mermaidSamples[i];
                const card = document.createElement('div');
                card.className = 'sample-card';
                card.onclick = () => insertSample(sample.code);

                const title = document.createElement('div');
                title.className = 'sample-card-title';
                title.textContent = sample.name[currentLang] || sample.name.en;

                const preview = document.createElement('div');
                preview.className = 'sample-card-preview';

                // Extract mermaid code from the markdown code block
                const mermaidCode = sample.code.replace(/```mermaid\n?/, '').replace(/\n?```$/, '');
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                preview.appendChild(mermaidDiv);

                card.appendChild(title);
                card.appendChild(preview);
                container.appendChild(card);
            }

            // Re-render mermaid diagrams
            try {
                await mermaid.run({ nodes: container.querySelectorAll('.mermaid') });
            } catch (e) {
                console.log('Mermaid render error in modal:', e);
            }
        }

        function renderMathSamples() {
            const container = document.getElementById('math-samples');
            container.innerHTML = '';

            mathSamples.forEach(sample => {
                const card = document.createElement('div');
                card.className = 'sample-card';
                card.onclick = () => insertSample(sample.code);

                const title = document.createElement('div');
                title.className = 'sample-card-title';
                title.textContent = sample.name[currentLang] || sample.name.en;

                const preview = document.createElement('div');
                preview.className = 'sample-card-preview';

                // Render KaTeX
                const mathCode = sample.code.replace(/^\$\$/, '').replace(/\$\$$/, '');
                try {
                    preview.innerHTML = katex.renderToString(mathCode, {
                        throwOnError: false,
                        displayMode: true
                    });
                } catch (e) {
                    preview.textContent = sample.code;
                }

                card.appendChild(title);
                card.appendChild(preview);
                container.appendChild(card);
            });
        }

        function insertSample(code) {
            // Save state before change for undo
            saveState();

            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const value = editor.value;

            // Add newlines if not at beginning or if there's content before
            let insertion = code;
            if (start > 0 && value[start - 1] !== '\n') {
                insertion = '\n\n' + insertion;
            }
            if (end < value.length && value[end] !== '\n') {
                insertion = insertion + '\n\n';
            }

            editor.value = value.substring(0, start) + insertion + value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + insertion.length;

            // Save state after change for undo
            saveState();

            isDirty = true;
            schedulePreviewUpdate();
            updateStats();
            closeSampleModal();
            showToast(t('sampleInserted'));
            editor.focus();
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (isDirty) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    
    </script>

    <!-- Sample Code Modal -->
    <div class="modal-overlay" id="sample-modal" onclick="closeSampleModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" data-i18n="sampleCode">Sample Code</span>
                <button class="modal-close" onclick="closeSampleModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="mermaid" onclick="switchSampleTab('mermaid')">
                    <span data-i18n="mermaidDiagrams">Mermaid Diagrams</span>
                </button>
                <button class="modal-tab" data-tab="math" onclick="switchSampleTab('math')">
                    <span data-i18n="mathFormulas">Math Formulas</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="tab-content active" id="tab-mermaid">
                    <div class="sample-grid" id="mermaid-samples"></div>
                </div>
                <div class="tab-content" id="tab-math">
                    <div class="sample-grid" id="math-samples"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>